
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ContactManager - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="ContactManager                              In this advanced Rails project, you&#8217;ll create a contact manager. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tutorials.jumpstartlab.com/projects/contact_manager.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">

  <!-- TAB SLIDE OUT -->
  <script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.tabSlideOut.v1.3.js"></script>

  <!-- SEARCH -->
  <script src="/search.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.slide-out-div').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        pathToTabImage: '/images/feedback_tabv2.png', //path to the image for the tab //Optionally can be set using css
        imageHeight: '130px',                     //height of tab image           //Optionally can be set using css
        imageWidth: '36px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'left',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 300,                               //speed of animation
        action: 'click',                          //options: 'click' or 'hover', action to trigger animation
        topPos: '200px',                          //position from the top/ use if tabLocation is left or right
        leftPos: '20px',                          //position from left/ use if tabLocation is bottom or top
        fixedPosition: true                      //options: true makes it stick(fixed position) on scroll
        });
      });
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner">
    <hgroup>
  <h1>Jumpstart Lab Curriculum</h1>
  
</hgroup>

  </header>

  <nav role="navigation">
    <ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tutorials.jumpstartlab.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
  <li><div id="search">
  <form>
    <input type="text" id="st-search-input" class="st-search-input" />
  </form>
</div>
</li>
</ul>
  </nav>

  <div id="main">
    <div id="content">
      <div>
  <article role="article">
    
    
      <header>
        <h1 class="entry-title">
          ContactManager
        </h1>
        
      </header>
    
    <p>In this advanced Rails project, you&#8217;ll create a contact manager. The tools that you will use include the following:</p>

<ul>
<li>Testing with <a href="http://relishapp.com/rspec/">RSpec</a> to drive your development</li>
<li>Creating view templates with <a href="http://haml-lang.com/">Haml</a> and <a href="http://sass-lang.com/">Sass</a></li>
<li>Building reusable view code with helpers and partials</li>
<li>Refactoring</li>
<li>Managing authentication and authorization</li>
<li>Server and client-side validations</li>
<li>Deployment and monitoring</li>
</ul>

<p>This project assumes you have already completed the <a href="http://tutorials.jumpstartlab.com/topics/environment/environment.html">general Ruby setup</a> and I&#8217;m using <em>Ruby 2.1.3</em>. We&#8217;ll rely on the Bundler system to install other gems for us along the way.</p>

<p>In addition, I recommend you use the Atom IDE available <a href="https://atom.io/">here</a>.</p>

<p>We&#8217;ll use an iterative approach to develop one feature at a time. Here goes!</p>

<h2>I0: Up and Running</h2>

<p>Let&#8217;s lay the groundwork for our project. In your terminal, switch to the directory where you&#8217;d like your project to be stored.</p>

<p>Lets install Rails or ensure that we have it installed.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails -v</span><span class='line output'>Rails is not currently installed on this system.</span><span class='line command'>gem install rails</span><span class='line output'>...</span><span class='line command'>rails -v</span><span class='line output'>Rails 4.1.6</span></code></pre></td></tr></table></div></div>
        </div>

<div class="note">
<p>It is not necessary to have the same exact version of Rails specified here in the tutorial. The tutorial will definitely work with the specified version but will also likely work with a similar version.</p>
</div>

<p>Let&#8217;s create a new Rails project:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails new contact_manager --skip-test-unit</span><span class='line command'>cd contact_manager</span></code></pre></td></tr></table></div></div>
        </div>

<div class="note">
<p>The `&#8211;skip-test-unit` option here appended to the **rails** command tells Rails not to generate a `test` directory associated with the default **Test::Unit** framework.</p>
</div>

<p>Open the project in your editor of choice.</p>

<h3>Using RSpec instead of TestUnit</h3>

<p>Rails by default uses the <a href="https://github.com/test-unit/test-unit">TestUnit</a> testing library. For this tutorial we instead want to use <a href="https://github.com/rspec/rspec-rails">RSpec</a>.</p>

<p>First, we need to add RSpec to the list of dependencies.</p>

<p>Open the <code>Gemfile</code> and add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Second, we need to install this new dependency:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle install</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now rspec-rails is available, but we still need to do some setup to make it all work. Running this generator will perform the setup for you:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rails generate rspec:install</span><span class='line output'>create  .rspec</span><span class='line output'>create  spec</span><span class='line output'>create  spec/spec_helper.rb</span><span class='line output'>create  spec/rails_helper.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now your project is set to use RSpec and the generators will use RSpec by default.</p>

<h3>Using Unicorn instead of Webrick</h3>

<p>Open a second terminal window, move into your project directory, then start your server with:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rails server</span></code></pre></td></tr></table></div></div>
        </div>

<p>This will, by default, use the Webrick server which is slow as molasses. Hit <code>Ctrl-C</code> to stop it. Some of the alternative servers are <a href="https://github.com/mongrel/mongrel">mongrel</a>, <a href="http://unicorn.bogomips.org/">unicorn</a>, <a href="http://code.macournoyer.com/thin/">thin</a>, and <a href="http://puma.io/">puma</a>.</p>

<p>Here&#8217;s how to setup unicorn.</p>

<div class="note">
<p>Unicorn will not work on Windows. You can follow the same steps below though by substituting in &#8216;thin&#8217; for &#8216;unicorn&#8217;.</p>
</div>

<p>First, add this the dependency to your <code>Gemfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Second, we need to install this new dependency:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle install</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now, start the server:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec unicorn</span></code></pre></td></tr></table></div></div>
        </div>

<p>Load <a href="http://0.0.0.0:8080"><a href="http://0.0.0.0:8080">http://0.0.0.0:8080</a></a> in your browser and you should see the Rails splash screen. Click the &quot;About your applicationâ€™s environment&quot; link and you should see all your library versions. If your database were not installed properly or inaccessible, you&#8217;d see an error here.</p>

<h3>Git Setup</h3>

<p>I&#8217;ll assume that you&#8217;ve already setup <a href="http://git-scm.com/">Git</a> on your system.</p>

<p>First, we need to tell git that we want to start tracking changes for our current project.</p>

<p>Within your project directory initialize your project as a git repository.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git init</span></code></pre></td></tr></table></div></div>
        </div>

<p>Second, we need to save our work. We do that by adding all the files we want to save to a list. Then committing that list of files.</p>

<p>We add all the files in our project (e.g. <code>.</code>) to that list and then commit them:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Generate initial project"</span></code></pre></td></tr></table></div></div>
        </div>

<p>At this point if you&#8217;re using <a href="https://github.com/">GitHub</a>, you could <a href="https://github.com/new">create a repository</a>, add that remote and push to it. For purposes of this tutorial, we&#8217;ll just manage the code locally.</p>

<h3>Shipping to Heroku</h3>

<p>We want to host our Rails application on the internet using the popular <a href="http://www.heroku.com/">Heroku</a> service.</p>

<p>If you don&#8217;t already have one, you&#8217;ll need to create <a href="https://id.heroku.com/signup/www-header">a Heroku account</a>. After creating your account download and install the <a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a>.</p>

<p>Heroku requires applications to use a PostgresSQL database and not a Sqlite database. So we need to update our application to use the PostgresSQL gem (named <strong>pg</strong>). Along with installing the <strong>pg</strong> gem we will also need to install and configure a PostgreSQL database. This could be trivial amount of work or may consume an entire afternoon.</p>

<p>An ideal situation is if we could continue to use Sqlite locally and PostgresSQL only on Heroku. This configuration is indeed possible.</p>

<p>Our application, by default is run in <strong>development</strong> mode.</p>

<p>When we run our tests the application runs in <strong>test</strong> mode.</p>

<p>When we deploy to Heroku, our application is run in <strong>production</strong> mode.</p>

<p>We want to continue to use Sqlite while in <strong>development</strong> and <strong>test</strong>. We will use PostgresSQL in <strong>production</strong>.</p>

<p>Find the line in your gem file that says <code>gem 'sqlite3'</code> and move this into the <code>:development, :test</code> group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Create a new group called :production, and add the PostgreSQL gem to it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the <code>bundle install</code> command again to update your database dependencies.</p>

<p>Commit your code again.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line output'>git add .</span><span class='line command'>git commit -m "Update database dependencies"</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now, let&#8217;s update <code>production.rb</code> to serve static assets.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">serve_static_assets</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>

<p>Without the line above, you may have difficulty deleting once deployed to Heroku.</p>

<p>Next let&#8217;s integrate <a href="http://www.heroku.com/">Heroku</a>.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>heroku create</span></code></pre></td></tr></table></div></div>
        </div>

<p>The toolbelt will ask for your username and password the first time you run the create, but after that you&#8217;ll be using an SSH key for authentication.</p>

<p>After running the create command, you&#8217;ll get back the URL where the app is accessible. Try loading the URL in your browser and you&#8217;ll see the generic Heroku splash screen. It&#8217;s not running your code yet so push your project to Heroku.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>git push heroku master</span><span class='line output'></span><span class='line output'>-----> Launching... done</span><span class='line output'>http://ADJECTIVE-WORD-NUMBER.heroku.com deployed to Heroku</span></code></pre></td></tr></table></div></div>
        </div>

<p>If you see a <code>Permission denied (publickey).</code> error, your SSH key needs to be uploaded to Heroku.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line output'>heroku keys:add ~/.ssh/id_rsa.pub</span><span class='line output'>Uploading SSH public key ...</span></code></pre></td></tr></table></div></div>
        </div>

<p>You should now be able to deploy.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>git push heroku master</span><span class='line output'></span><span class='line output'>-----> Launching... done</span><span class='line output'>http://ADJECTIVE-WORD-NUMBER.heroku.com deployed to Heroku</span></code></pre></td></tr></table></div></div>
        </div>

<p>Refresh your browser and you should see an error that says <code>The page you were looking for doesn't exist.</code>. Don&#8217;t worry, everything should be running fine.</p>

<p>Now we&#8217;re ready to actually build our app!</p>

<h2>I1: Building People</h2>

<p>We&#8217;re building a contact manager, so let&#8217;s start with modeling people.</p>

<div class="note">
<p>Since this is an advanced tutorial we won&#8217;t slog through the details of
implementing a Person model, controller, and views. Instead we&#8217;ll take advantage
of scaffolding tools.</p>
</div>

<h3>A Feature Branch</h3>

<p>But first, let&#8217;s make a feature branch in git:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout -b implement-people</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now all our changes will be made on the <strong>implement-people</strong> branch. As we finish the iteration we&#8217;ll merge the changes back into master and ship it.</p>

<h3>Scaffold</h3>

<p>Let&#8217;s use the default rails generators to generate a scaffolded model named <code>Person</code> that has a <code>first_name</code> and <code>last_name</code>:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rails generate scaffold Person first_name:string last_name:string</span><span class='line command'>bundle exec rake db:migrate</span></code></pre></td></tr></table></div></div>
        </div>

<p>The generators created test-related files for us. They saw that we&#8217;re using RSpec and created corresponding controller and model test files. Let&#8217;s run those tests now:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec</span></code></pre></td></tr></table></div></div>
        </div>

<p>There should be 0 failing tests and 17 pending.</p>

<p>This is a great time to add and commit your changes.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Generated Person model"</span></code></pre></td></tr></table></div></div>
        </div>

<p>Open your browser to <a href="http://localhost:8080/people">http://localhost:8080/people</a> and try creating a few sample people.</p>

<h3>Starting with Testing</h3>

<p>When you ran your tests with <code>bundle exec rspec</code> you probably got a several pending tests:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec</span><span class='line output'>**.***************............</span><span class='line output'></span><span class='line output'>Pending:</span><span class='line output'>_Results Omitted_</span><span class='line output'></span><span class='line output'>Finished in 0.25264 seconds (files took 2.51 seconds to load)</span><span class='line output'>30 examples, 0 failures, 17 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>We&#8217;re not going to be using the <code>PeopleHelper</code> so let&#8217;s just get rid of the test file:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git rm spec/helpers/people_helper_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>Commit your changes:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git commit -m "Delete extraneous spec file"</span></code></pre></td></tr></table></div></div>
        </div>

<p>Let&#8217;s move on to the controller and get those tests to pass. The first part of my output currently looks like this:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec</span><span class='line output'>**.**************............</span><span class='line output'></span><span class='line output'>Pending:</span><span class='line output'>PeopleController GET index assigns all people as @people</span><span class='line output'># Add a hash of attributes valid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:40</span><span class='line output'>PeopleController GET show assigns the requested person as @person</span><span class='line output'># Add a hash of attributes valid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:48</span><span class='line output'>PeopleController GET edit assigns the requested person as @person</span><span class='line output'># Add a hash of attributes valid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:63</span><span class='line output'></span><span class='line output'>_REMAINING OUTPUT OMITTED_</span></code></pre></td></tr></table></div></div>
        </div>

<p>You&#8217;ll notice that each of these pending examples repeats the message <code>Add a hash of attributes valid for your model</code>. Let&#8217;s open <code>spec/controllers/people_controller_spec.rb</code> and search for that line of text. You should see code that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:valid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Add a hash of attributes valid for your model&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>skip</code> makes it so the tests that call <code>valid_attributes</code> are marked as pending. The parameter that is passed is the message that should be displayed.</p>

<p>Let&#8217;s update the code to provide valid attributes. These are going to be the minimum fields required to create a new Person record. In our case, we want a person to have a valid <code>first_name</code> and <code>last_name</code>. Let&#8217;s update the code to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:valid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Jane&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Doe&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Go back to your terminal and run your tests.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec</span><span class='line output'>.......***..**..*............</span><span class='line output'></span><span class='line output'>Pending:</span><span class='line output'>PeopleController POST create with invalid params assigns a newly created but unsaved person as @person</span><span class='line output'># Add a hash of attributes invalid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:91</span><span class='line output'>PeopleController POST create with invalid params re-renders the 'new' template</span><span class='line output'># Add a hash of attributes invalid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:96</span><span class='line output'>PeopleController PUT update with valid params updates the requested person</span><span class='line output'># Add a hash of attributes valid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:109</span><span class='line output'>PeopleController PUT update with invalid params assigns the person as @person</span><span class='line output'># Add a hash of attributes invalid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:130</span><span class='line output'>PeopleController PUT update with invalid params re-renders the 'edit' template</span><span class='line output'># Add a hash of attributes invalid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:136</span><span class='line output'>Person add some examples to (or delete) /Users/jmejia/code/turing/contact_manager/spec/models/person_spec.rb</span><span class='line output'># Not yet implemented</span><span class='line output'># ./spec/models/person_spec.rb:4</span><span class='line output'></span><span class='line output'>Finished in 0.34279 seconds (files took 2.65 seconds to load)</span><span class='line output'>29 examples, 0 failures, 6 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>Prior to that change we had 16 pending tests. Now we have 6. That simple change confirms that we are able to create new <code>People</code> with both a <code>first_name</code> and a <code>last_name</code>.</p>

<p>Let&#8217;s commit this change.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Added valid attributes to people controller spec"</span></code></pre></td></tr></table></div></div>
        </div>

<p>Looking back at your test output (run <code>bundle exec rspec</code> if you need to), you can see the repeated message <code>Add a hash of attributes invalid for your model</code>. Open <code>spec/controllers/people_controller_spec.rb</code> and search for that line. You should see the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:invalid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Add a hash of attributes invalid for your model&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Here is where we need to specify what invalid attributes should look like. In our case, we don&#8217;t want to be able to create a user that is missing a <code>first_name</code> or <code>last_name</code>. Let&#8217;s update this code to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:invalid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">first_name</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="kp">nil</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now when we run <code>bundle exec rspec</code> the end of your output should look like this:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<br></pre></td><td class='code'><pre><code><span class='line output'>Finished in 0.34863 seconds (files took 2.2 seconds to load)</span><span class='line output'>29 examples, 3 failures, 2 pending</span><span class='line output'></span><span class='line output'>Failed examples:</span><span class='line output'></span><span class='line output'>rspec ./spec/controllers/people_controller_spec.rb:91 # PeopleController POST create with invalid params assigns a newly created but unsaved person as @person</span><span class='line output'>rspec ./spec/controllers/people_controller_spec.rb:96 # PeopleController POST create with invalid params re-renders the 'new' template</span><span class='line output'>rspec ./spec/controllers/people_controller_spec.rb:136 # PeopleController PUT update with invalid params re-renders the 'edit' template</span></code></pre></td></tr></table></div></div>
        </div>

<p>We have 3 failures because we said <code>nil</code> values for first and last names should not be valid. As it stands, we haven&#8217;t written any code to make empty strings invalid.</p>

<p>This is a good point to discuss models. The model is the application&#8217;s representation of the data layer, the foundation of any functionality. In the same way we&#8217;ll build low-level tests on the models which will be the foundation of our test suite. By focusing on the model level we will actually get the failing controller specs to pass.</p>

<p>To start, let&#8217;s run <em>only</em> <code>person_spec.rb</code> which tests the <code>Person</code> model. Up until now we have been running the entire test suite.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/models/person_spec.rb</span><span class='line output'>*</span><span class='line output'></span><span class='line output'>Pending:</span><span class='line output'>Person add some examples to (or delete) /Users/jmejia/code/turing/contact_manager/spec/models/person_spec.rb</span><span class='line output'># Not yet implemented</span><span class='line output'># ./spec/models/person_spec.rb:4</span><span class='line output'></span><span class='line output'>Finished in 0.00067 seconds (files took 2.78 seconds to load)</span><span class='line output'>1 example, 0 failures, 1 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>We have 1 pending test and a message that says <code>Not yet implemented</code>. Let&#8217;s write a useful test.</p>

<p>Open <code>spec/models/person_spec.rb</code> and you&#8217;ll see this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">Person</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>describe</code> block will wrap all of our tests (also called examples) in RSpec parlance.</p>

<h3>Testing for Data Presence</h3>

<p>Let&#8217;s create an example using the <code>it</code> method to test that a <code>Person</code> without a <code>first_name</code> is invalid:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">Person</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;is invalid without a first name&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_valid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your test again:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<br><span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/models/person_spec.rb</span><span class='line output'>F</span><span class='line output'></span><span class='line output'>Failures:</span><span class='line output'></span><span class='line output'>1) Person is invalid without a first name</span><span class='line output'>Failure/Error: expect(person).not_to be_valid</span><span class='line output'>expected #<Person id: nil, first_name: nil, last_name: nil, created_at: nil, updated_at: nil> not to be valid</span><span class='line output'># ./spec/models/person_spec.rb:6:in `block (2 levels) in <top (required)>'</span><span class='line output'></span><span class='line output'>Finished in 0.01008 seconds (files took 2.24 seconds to load)</span><span class='line output'>1 example, 1 failure</span><span class='line output'></span><span class='line output'>Failed examples:</span><span class='line output'></span><span class='line output'>rspec ./spec/models/person_spec.rb:4 # Person is invalid without a first name</span></code></pre></td></tr></table></div></div>
        </div>

<p>The test failed because it expected a person with no first name to be invalid, but instead it <em>was</em> valid. We can fix that by adding a validation for first name inside the model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you run the test again you&#8217;ll see that we now have a passing test.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/models/person_spec.rb</span><span class='line output'>.</span><span class='line output'></span><span class='line output'>Finished in 0.01684 seconds (files took 2.45 seconds to load)</span><span class='line output'>1 example, 0 failures</span></code></pre></td></tr></table></div></div>
        </div>

<p>Looking good! Let&#8217;s also require people to have last names.</p>

<p>Create a test that asserts that a <code>Person</code> without a last name is invalid:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is invalid without a last name&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run <code>bundle exec rspec spec/models/person_spec.rb</code>. The test you just wrote should be failing.</p>

<p>Fix the test by adding a validation to the model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run <code>bundle exec rspec spec/models/person_spec.rb</code> and you should see 2 passing tests.</p>

<p>And now if you run the entire suite, the controller tests that were failing should be passing.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
<span class='line-number'>&nbsp;</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec</span><span class='line output'>.........*....................</span><span class='line output'></span><span class='line output'>Pending:</span><span class='line output'>PeopleController PUT update with valid params updates the requested person</span><span class='line output'># Add a hash of attributes valid for your model</span><span class='line output'># ./spec/controllers/people_controller_spec.rb:109</span><span class='line output'></span><span class='line output'>Finished in 0.35373 seconds (files took 2.5 seconds to load)</span><span class='line output'>30 examples, 0 failures, 1 pending</span></code></pre></td></tr></table></div></div>
        </div>

<p>Very nice! We have one last pending test. Open <code>spec/controllers/people_controller_spec.rb</code> and find the line containing <code>Add a hash of attributes valid for your model</code>. The code should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;PUT update&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;with valid params&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:new_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Add a hash of attributes valid for your model&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;updates the requested person&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'>      <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="p">{</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">person</span><span class="o">.</span><span class="n">to_param</span><span class="p">,</span> <span class="ss">:person</span> <span class="o">=&gt;</span> <span class="n">new_attributes</span><span class="p">},</span> <span class="n">valid_session</span>
</span><span class='line'>      <span class="n">person</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'>      <span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Add assertions for updated state&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># remaining code omitted</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This test is checking to make sure we can update the attributes of a person through the controller. To get this to pass we first need to provide valid attributes to update the person. Update the <code>new_attributes</code> to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:new_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">{</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;NewFirstName&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;NewLastName&#39;</span><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Next, we need to update the test to check that the new values have persisted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;updates the requested person&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'>  <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="p">{</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">person</span><span class="o">.</span><span class="n">to_param</span><span class="p">,</span> <span class="ss">:person</span> <span class="o">=&gt;</span> <span class="n">new_attributes</span><span class="p">},</span> <span class="n">valid_session</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;NewFirstName&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;NewLastName&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your test suite and if everything is passing, commit your changes:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Implement validations on person"</span></code></pre></td></tr></table></div></div>
        </div>

<h3>Experimenting with Our Tests</h3>

<p>Go into the <code>person.rb</code> model and temporarily remove <code>:first_name</code> from the <code>validates</code>
line. Run your tests. What happened?</p>

<p>This is what&#8217;s called a false positive. The <code>is invalid without a first_name</code> test is passing, but not for the right reason. Even though we&#8217;re not validating <code>first_name</code>, the test is passing because the model it&#8217;s building doesn&#8217;t have a valid <code>last_name</code> either. That causes the validation to fail and our test to pass. We need to improve the Person object created in the tests so that only the attribute being tested is invalid. Let&#8217;s refactor.</p>

<p>First, just below the <code>describe</code> line of our <code>person_spec</code>, let&#8217;s add this code which will be available to all of our examples:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Update your first name and last name tests to use the person object defined in the <code>let</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is invalid without a first name&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s1">&#39;is invalid without a last name&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests and now the <code>is invalid without a first name</code> test should fail. Read the output that RSpec gives you to help find the problem. In this case, it&#8217;s easy &#8211; just add <code>:first_name</code> back where you removed it from the validation in <code>person.rb</code>.</p>

<p>Now that everything is passing, commit your changes.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Fix false positive in person specs"</span></code></pre></td></tr></table></div></div>
        </div>

<h3>Checking the Checkers</h3>

<p>The <code>let</code> clause we wrote will make writing test examples a lot easier, but we had better have a test to ensure that what we&#8217;re calling <code>person</code> is actually valid! You can do this by adding a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is valid&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests. If they&#8217;re passing (and they should be) commit your changes.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Confirm person is valid in person spec"</span></code></pre></td></tr></table></div></div>
        </div>

<h3>Ship It</h3>

<p>This branch is done. Let&#8217;s go back to the master branch and merge it in:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout master</span><span class='line command'>git merge implement-people</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now it&#8217;s ready to send to Heroku and run our migrations:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git push heroku master</span><span class='line command'>heroku run rake db:migrate</span></code></pre></td></tr></table></div></div>
        </div>

<p>Open up your production app in your browser and visit <code>/people</code>. You should be able to create sample people like you did on your development server.</p>

<h2>I2: Phone Numbers</h2>

<h3>A Feature Branch</h3>

<p>Let&#8217;s again make a feature branch in git:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout -b implement-phone-numbers</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now all our changes will be made on the <strong>implement-phone-numbers</strong> branch.
As we finish the iteration we&#8217;ll merge the changes back into master and ship it.</p>

<h3>Modeling The Objects</h3>

<p>First, let&#8217;s think about the data relationship. A person is going to have multiple phone numbers, and a phone number is going to belong to one person. In the database world, this is a one-to-many relationship, one person has many phone numbers.</p>

<h4>One-to-Many Relationship</h4>

<p>The way this is traditionally implemented in a relational database is that the &quot;many&quot; table (the phone number table, in this case) holds a unique identifier, called a foreign key, pointing back to the row from the &quot;one&quot; (person) table that it belongs to. For example, we might have a person with ID 6. That person would have phone numbers that would each have a foreign key <code>person_id</code> with the value 6.</p>

<h4>A Person Has Phone Numbers</h4>

<p>With that understanding, let&#8217;s write a test. We just want to check that a person
is capable of having phone numbers. In your <code>person_spec.rb</code> let&#8217;s add this test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;has an array of phone numbers&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests and make sure the test fails with <code>undefined method 'phone_numbers'</code>. Now we&#8217;re ready to create a <code>PhoneNumber</code> model and corresponding association in the <code>Person</code> model.</p>

<h4>Scaffolding the Phone Number Model</h4>

<p>We&#8217;ll use the scaffold generator again to save us a little time. For now we&#8217;ll keep the phone number simple that contains the phone number, represented as a String, and a reference to the Person that owns the number. Generate it with this command at the terminal:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rails generate scaffold PhoneNumber number:string person_id:integer</span></code></pre></td></tr></table></div></div>
        </div>

<p>Run the migrations:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rake db:migrate</span></code></pre></td></tr></table></div></div>
        </div>

<p>Run the tests again. The failing test is still failing and there are now 17 pending tests. Let&#8217;s stay focused on the failure.</p>

<h4>Setting Relationships</h4>

<p>Next open the <code>person.rb</code> model and add the following association:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:phone_numbers</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests and you should have no failing tests.</p>

<p>We have pending tests in the <code>phone_number_spec.rb</code>, <code>phone_numbers_controller_spec.rb</code> and <code>phone_numbers_helper_spec.rb</code>.</p>

<p>If your tests are all passing or pending, commit all your changes:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Generate phone number and associate with person"</span></code></pre></td></tr></table></div></div>
        </div>

<p>You can try out the new association by going into the console via <code>bundle exec rails console</code> and adding a phone number manually:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">IRB</h1>
          <div class="container"><div class="irb"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>2.1.1 :001&gt;</span>
<span class='line-number'>2.1.1 :002&gt;</span>
</pre></td><td class='code'><pre><code><span class='line command'>p = Person.first</span><span class='line command'>p.phone_numbers.create(number: '2024605555')</span></code></pre></td></tr></table></div></div>
        </div>

<h4>Validating Phone Numbers</h4>

<p>Right now the phone number is just stored as a string, so maybe the user enters a good-looking one like &quot;2024600772&quot; or maybe they enter &quot;please-don&#8217;t-call-me&quot;. Let&#8217;s add some validations to make sure the phone number can&#8217;t be blank.</p>

<p>Go into <code>phone_number_spec.rb</code> and mimic some of the same things we did in <code>person_spec.rb</code>. We can start off by writing a <code>let</code> block to setup our <code>PhoneNumber</code> object. Enter this just below the <code>describe</code> line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span> <span class="p">{</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Delete the <code>pending</code> test, and add a test for a valid number:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is valid&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests. They should be passing.</p>

<p>We want to start working on valid formats for a phone number, so let&#8217;s write a test that states that a phone number cannot be blank:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is invalid without a number&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">phone_number</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you run your tests, this test should be the only failing test.</p>

<p>Go into the <code>phone_number.rb</code> model and add a validation checking the existence of the <code>number</code>, run your tests again. This test passes, but now the first one is failing.</p>

<p>Update the <code>let</code> block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span> <span class="p">{</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;1112223333&quot;</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make sure your tests are green, and then commit your changes.</p>

<p>A <code>PhoneNumber</code> shouldn&#8217;t be allowed to float out in space, so let&#8217;s require that it be attached to a <code>Person</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;must have a reference to a person&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">phone_number</span><span class="o">.</span><span class="n">person_id</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_valid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests again and your new test should fail. Add a validation that checks the presence of <code>person_id</code> in your phone number, then run your tests again.</p>

<p>That got the new test to pass but broke another test. This is the spec for the valid phone number:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Failures:
</span><span class='line'>
</span><span class='line'>  1<span class="o">)</span> PhoneNumber is valid
</span><span class='line'>     Failure/Error: expect<span class="o">(</span>phone_number<span class="o">)</span>.to be_valid
</span><span class='line'>       expected <span class="c">#&lt;PhoneNumber id: nil, number: &quot;1112223333&quot;, person_id: nil, created_at: nil, updated_at: nil&gt; to be valid, but got errors: Person can&#39;t be blank</span>
</span><span class='line'>     <span class="c"># ./spec/models/phone_number_spec.rb:7:in `block (2 levels) in &lt;top (required)&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Update your <code>let</code> block in the <code>spec/models/phone_number_spec.rb</code> again, giving it a <code>person_id</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span> <span class="p">{</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;1112223333&quot;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now let&#8217;s get the pending controller tests to pass.</p>

<p>Open up the file <code>spec/controllers/phone_numbers_controller_spec.rb</code> and find the method definition for <code>valid_attributes</code>. In order to pass our validations we need to add <code>number</code> and <code>person_id</code> attributes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:valid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">number</span><span class="p">:</span> <span class="s2">&quot;MyString&quot;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Re-run your tests and you should be down to 6 pending tests.</p>

<p>Now add invalid attributes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:invalid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">number</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="kp">nil</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Re-run your tests and there should be 2 pending tests. Let&#8217;s write a passing test for the last pending controller spec. Within <code>spec/controllers/phone_numbers_controller_spec.rb</code> find the line containing <code>skip(&quot;Add a hash of attributes valid for your model&quot;)</code>. Update the <code>:new_attributes</code> let block and the test just below it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:new_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">{</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;MyNewString&#39;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s2">&quot;updates the requested phone_number&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">phone_number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'>  <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="p">{</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">to_param</span><span class="p">,</span> <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">new_attributes</span><span class="p">},</span> <span class="n">valid_session</span>
</span><span class='line'>  <span class="n">phone_number</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;MyNewString&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="o">.</span><span class="n">person_id</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests and there should be 1 pending and 0 failing.</p>

<p>That&#8217;s a lot of work for two validations, but these are an important part of our testing base. If somehow one of the validations got deleted accidentally, we&#8217;d know it right away.</p>

<p>If your tests are all passing, go ahead and commit the changes so you don&#8217;t lose all that hard work!</p>

<p>We&#8217;re not going to be using the <code>PhoneNumberHelper</code> so let&#8217;s get rid of the test file:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git rm spec/helpers/phone_numbers_helper_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>Commit your changes:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git commit -m "Delete extraneous spec file"</span></code></pre></td></tr></table></div></div>
        </div>

<p>All tests should be passing.</p>

<p>Finally, let&#8217;s connect the phone number to a person.</p>

<p>Within <code>phone_number_spec.rb</code>, write a test ensuring that a <code>PhoneNumber</code> has a method to give you back the associated <code>Person</code> object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is associated with a person&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your test. Notice the failure. That is because the relationship from
Phone Numbers and a Person has not been established.</p>

<p>Open <code>phone_number.rb</code> and add the following association:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">belongs_to</span> <span class="ss">:person</span>
</span></code></pre></td></tr></table></div></figure>

<p>Commit your changes.</p>

<h3>Creating some seed data</h3>

<p>Go into your console (<code>bundle exec rails console</code>) and create a person and a couple of phone numbers:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">IRB</h1>
          <div class="container"><div class="irb"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>2.1.1 :001&gt;</span>
<span class='line-number'>2.1.1 :002&gt;</span>
<span class='line-number'>2.1.1 :003&gt;</span>
</pre></td><td class='code'><pre><code><span class='line command'>person = Person.create(first_name: 'Alice', last_name: 'Smith')</span><span class='line command'>person.phone_numbers.create(number: '555-1234')</span><span class='line command'>person.phone_numbers.create(number: '555-9876')</span></code></pre></td></tr></table></div></div>
        </div>

<p>Then get the person ID for that person:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">IRB</h1>
          <div class="container"><div class="irb"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>2.1.1 :001&gt;</span>
</pre></td><td class='code'><pre><code><span class='line command'>person.id</span></code></pre></td></tr></table></div></div>
        </div>

<h3>Building a Web-based Workflow</h3>

<p>Up to this point we&#8217;ve created phone numbers through the console. Let&#8217;s build up a web-based workflow.</p>

<h4>What You Got From Scaffolding</h4>

<p>When the scaffold generator ran it gave us a controller and some view templates. Check out the <em>new</em> form by loading up <a href="http://localhost:8080/phone_numbers/new">/phone_numbers/new</a> in your browser.</p>

<p>It&#8217;s not that bad, but it&#8217;s not good enough.</p>

<h4>Person-centric Workflow</h4>

<p>Here&#8217;s what the customer wants:</p>

<p><em>&quot;When I am looking at a single person&#8217;s page, I click an add link that takes me to the page where I enter the phone number. I click save, then I see the person and their updated information&quot;</em></p>

<p>Go to the show page for the person you just created in the console. If that person&#8217;s ID is <code>1</code>, then the url is <code>/people/1</code>.</p>

<p>The show page doesn&#8217;t even list the existing phone numbers.</p>

<p>Let&#8217;s add that.</p>

<h4>How do you test views?</h4>

<p>We don&#8217;t want to lose the value of testing, so we need a way to test the person&#8217;s show view. We want to see that the rendered HTML lists the phone numbers.</p>

<p>When we want to test the output HTML we&#8217;re talking about an <em>integration test</em>. My favorite way to build those is using the Capybara gem with RSpec. Let&#8217;s get Capybara setup by opening your <code>Gemfile</code> and adding this line inside the <code>:development</code> group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then run <code>bundle</code> from your command line and it&#8217;ll install the gem.</p>

<p>Create a new folder named <code>spec/features</code>. In that folder let&#8217;s make a file
named <code>person_view_spec.rb</code>. Then here&#8217;s how I&#8217;d write the examples:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;the person view&#39;</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="ss">:feature</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="p">{</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Doe&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;555-1234&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;555-5678&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">visit</span> <span class="n">person_path</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;shows the phone numbers&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">phone</span><span class="o">|</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="n">phone</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests. They should fail.</p>

<p>Open up <code>app/views/people/show.html.erb</code> and add this code above the edit link:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% @person.phone_numbers.each </span><span class="k">do</span> <span class="o">|</span><span class="n">phone</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">    &lt;li&gt;</span><span class="o">&lt;%=</span> <span class="n">phone</span><span class="o">.</span><span class="n">number</span> <span class="sx">%&gt;&lt;/li&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Re-run the tests, and they should pass.</p>

<p>The customer wants to be able to add new phone numbers, so let&#8217;s write a test for that.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;has a link to add a new phone number&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Add phone number&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">new_phone_number_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test will fail. Go back to the <code>show</code> view, and add a link to add a new phone number:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Add phone number&#39;</span><span class="p">,</span> <span class="n">new_phone_number_path</span> <span class="o">%&gt;</span> <span class="o">|</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now the test should pass.</p>

<p>Ok, so now we need to be able to actually add a phone number. Let&#8217;s write a test
that checks that when we follow the &#8216;Add phone number&#8217; link and add a
new phone number we end up back on the show page for the person, and that number is in the page.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;adds a new phone number&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;Add phone number&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Number&#39;</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="s1">&#39;555-8888&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Phone number&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">person_path</span><span class="p">(</span><span class="n">person</span><span class="p">))</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;555-8888&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This fails because we&#8217;ve been redirected to the wrong location. We need to step
down one level. Let&#8217;s mark this test pending for now by adding an <code>x</code> in front of <code>it</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">xit</span> <span class="s1">&#39;adds a new phone number&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Open up the <code>spec/controllers/phone_numbers_controller_spec.rb</code> and find the
test called <code>it &quot;redirects to the created phone_number&quot;</code>.</p>

<p>This is not the behavior we are looking for. Let&#8217;s change the expectation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;redirects to the phone number&#39;s person&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">alice</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">valid_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;555-8888&#39;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="n">alice</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'>  <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="p">{</span><span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">valid_attributes</span><span class="p">},</span> <span class="n">valid_session</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run <code>bundle exec rspec spec/controllers/phone_numbers_controller_spec.rb</code>, and this test now fails.</p>

<p>Open up <code>app/controllers/phone_numbers_controller.rb</code> and look at the <code>create</code> action. When the phone number successfully saves, redirect to the phone number&#8217;s attached person <code>redirect_to @phone_number.person</code>.</p>

<p>Re-run your tests, and this test passes, but now two other tests are failing!</p>

<p>Both are failing for the same reason:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  ActionController::ActionControllerError:
</span><span class='line'>    Cannot redirect to nil!
</span><span class='line'>  <span class="c"># ./app/controllers/phone_numbers_controller.rb:47:in `block (2 levels) in create&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>In the create method of the phone numbers controller, we&#8217;re trying to redirect to nil. That makes sense, since the phone number we created is using the default valid attributes, which lists the <code>person_id</code> as <code>1</code>. When the code asks the database for the person with id <code>1</code>, the database can&#8217;t find a match, and we end up with a <code>nil</code>. That&#8217;s not going to work, so let&#8217;s give those two tests a real person to work with.</p>

<p>We can use the person object we just created for our previous test. Promote <code>alice</code> to a <code>let</code>. We want it to be valid for all of the <code>create</code> specs, so we need to place that line of code inside the describe for the <code>create</code> <code>with valid params</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;POST create&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;with valid params&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:alice</span><span class="p">)</span> <span class="p">{</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>We need to do the same with the <code>valid_attributes</code> local variable. Put it right below the <code>let(:alice)</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:valid_attributes</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;555-1234&#39;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="n">alice</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the controller tests again, and this time, they should pass.</p>

<p>Delete the <code>pending</code> declaration in your integration test and run all the tests. It is still failing. Let&#8217;s take a look at what&#8217;s going on here.</p>

<p>Open up your application and go to <a href="http://localhost:8080/people/1">/people/1</a>. Click to add a phone number, and now click the <code>Create Phone number</code> button.</p>

<p>You get an error message. The form includes a field for providing the <code>person_id</code>, but our test is not filling it in. Without a <code>person_id</code>, the number can&#8217;t be saved (remember, we made <code>person_id</code> a required attribute for phone numbers).</p>

<p>We could require our users to manually fill in the ID for the person they are creating a phone number for, but this seems tedious. Since the user has just come from the person page, we should be able to fill in the <code>person_id</code> for them automatically. One way to do this is by encoding it into the URL as a query parameter.</p>

<p>Make the test pending again, and go back to the one above it. Change it so that the phone number path takes a person&#8217;s id.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;has a link to add a new phone number&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Add phone number&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">new_phone_number_path</span><span class="p">(</span><span class="n">person_id</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the test and see it fail. Then open the <code>show</code> view and change the link:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Add phone number&#39;</span><span class="p">,</span> <span class="n">new_phone_number_path</span><span class="p">(</span><span class="n">person_id</span><span class="p">:</span> <span class="vi">@person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">%&gt;</span> <span class="o">|</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test now passes.</p>

<p>Go back to the feature and remove the <code>pending</code> declaration again.</p>

<p>Re-run the tests.</p>

<p>Still failing! We are passing the <code>person_id</code> to the <code>new_phone_number</code> route, but the form doesn&#8217;t take it into account when creating the number.</p>

<p>Go into the phone numbers controller, into the <code>new</code> action, and instead of <code>@phone_number = PhoneNumber.new</code> let&#8217;s say <code>@phone_number = PhoneNumber.new(person_id: params[:person_id])</code></p>

<p>Run the tests again, and finally they pass!</p>

<p>If you go to the <a href="http://localhost:3000/people/1">/people/1</a> page and click to create a new phone number, you&#8217;ll see that we are exposing the field for the person id to the user. That&#8217;s unnecessary.</p>

<p>Open up the <code>app/views/phone_numbers/_form.html.erb</code> file and change the <code>number_field</code> to be a <code>hidden_field</code>. Go ahead and delete the label for the person id as well.</p>

<p>Now all your tests should be passing, and you have a svelte phone number form to boot, so this is a good time to commit your changes.</p>

<h4>Workflow for Editing Phone Numbers</h4>

<p>OK, we have the functionality to add a number, let&#8217;s make it possible to edit phone numbers.</p>

<p>In <code>spec/features/person_view_spec.rb</code> add a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;has links to edit phone numbers&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">phone</span><span class="o">|</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">edit_phone_number_path</span><span class="p">(</span><span class="n">phone</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests, and they&#8217;ll fail. Open up the <code>people/show</code> template, and change the phone number list item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="sx">%= phone.number %&gt; &lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">edit_phone_number_path</span><span class="p">(</span><span class="n">phone</span><span class="p">))</span> <span class="sx">%&gt;&lt;/li&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>The tests pass.</p>

<p>Let&#8217;s make sure that the edit workflow works the way the customer expects it to.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;edits a phone number&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">phone</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>  <span class="n">old_number</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">number</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">first</span><span class="p">(</span><span class="ss">:link</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Number&#39;</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="s1">&#39;555-9191&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Update Phone number&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">person_path</span><span class="p">(</span><span class="n">person</span><span class="p">))</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;555-9191&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">have_content</span><span class="p">(</span><span class="n">old_number</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test is failing because it&#8217;s redirecting to the wrong place. Make the test pending while we go update the controller test.</p>

<p>In <code>spec/controllers/phone_numbers_controller_spec.rb</code> find the test <code>it 'redirects to the phone number'</code>. Create a person <code>bob</code> who has a phone number, and make sure the test expects to redirect to <code>bob</code> rather than the phone number.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;redirects to the phone_number&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">bob</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Jones&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">valid_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;555-5678&#39;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="n">bob</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'>  <span class="n">phone_number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'>  <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="p">{</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">to_param</span><span class="p">,</span> <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">valid_attributes</span><span class="p">},</span> <span class="n">valid_session</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">bob</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests, and this test will fail.</p>

<p>Find the <code>def update</code> action in the corresponding controller, and change it to redirect to <code>@phone_number.person</code>.</p>

<p>Re-run the tests, and now the test we just wrote should pass, but a couple of other tests are failing with the familiar <code>Cannot redirect to nil!</code> error.</p>

<p>Promote <code>bob</code> and his <code>valid_attributes</code> to a <code>let</code> in the describe block for <code>with valid params</code> within the <code>PUT update</code> describe block. We&#8217;ll also update <code>:new_attributes</code> to use <code>bob.id</code> so it has a valid person to redirect to.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;PUT update&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;with valid params&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:bob</span><span class="p">)</span> <span class="p">{</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s1">&#39;Jones&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:valid_attributes</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;555-5678&#39;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="n">bob</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:new_attributes</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;MyNewString&#39;</span><span class="p">,</span> <span class="n">person_id</span><span class="p">:</span> <span class="n">bob</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests, and they should now be passing.</p>

<p>Go back to the <code>person_view_spec.rb</code> feature, remove the <code>pending</code> declaration, and rerun the tests.</p>

<p>Everything should be passing. Go ahead and commit your changes.</p>

<h3>Destroying Phone Numbers</h3>

<p>Lastly the customer wants a delete link for each phone number. Follow a similar process to&#8230;</p>

<ul>
<li>Write a test that looks for a delete link for each phone number</li>
<li>Modify the partial to have that link</li>
<li>Try it in your browser and destroy a phone number</li>
<li>Update the expectation in the controller spec to specify that you get redirected to the phone number&#8217;s person after destroy</li>
<li>Fix the controller to redirect to the phone number&#8217;s person after destroy</li>
<li>Fix the resulting spec failure in the controller spec</li>
</ul>

<p>One note: the &quot;destroy&quot; action of a rails controller is triggered by sending an HTTP DELETE request to the appropriate path. You will need to use the <code>method</code> option on the <code>link_to</code> helper to include this in the delete links. It will look something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= link_to(&#39;delete&#39;, phone_number_path(phone_number), :method =</span><span class="o">&gt;</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Once your tests are passing, let&#8217;s commit!</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git add .</span><span class='line command'>git commit -m "Finish implementing phone number functionality"</span></code></pre></td></tr></table></div></div>
        </div>

<p>If that was all too easy try this <em>challenge</em>:</p>

<p>Write an integration test that destroys one of the phone numbers then ensure&#8217;s that it&#8217;s really gone from the database. You&#8217;ll need to use Capybara features like&#8230;</p>

<ul>
<li><code>page.click_link</code> to activate the destroy link</li>
<li><code>expect(current_path).to ==</code> to ensure you arrive at the show page</li>
<li>then check that the object is gone (one idea: verify that there is <em>no</em> delete link</li>
</ul>

<h3>Phone Numbers are Done&#8230;For Now!</h3>

<p>Wow, that was a lot of work, right?  Just to list some phone numbers?  Test-Driven Development (TDD) is really slow when you first get started, but after a few years you&#8217;ll have the hang of it!  I wish I were joking.</p>

<h4>Let&#8217;s Ship</h4>

<p>Hop over to your command prompt and let&#8217;s work with git. First, ensure that everything is committed on our branch:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git status</span></code></pre></td></tr></table></div></div>
        </div>

<p>This branch is done. Let&#8217;s go back to the master branch and merge it in:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout master</span><span class='line command'>git merge implement-phone-numbers</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now it&#8217;s ready to send to Heroku and run our migrations:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git push heroku master</span><span class='line command'>heroku run rake db:migrate</span></code></pre></td></tr></table></div></div>
        </div>

<p>Open up your production app in your browser and it should be rockin&#8217;!</p>

<h2>I3: Email Addresses</h2>

<p>What good is a contact manager that doesn&#8217;t track email addresses?  We can take most of the ideas from <code>PhoneNumber</code> and apply them to <code>EmailAddress</code>. This iteration is going to be largely independent because you&#8217;ve seen it all before.</p>

<h3>Start a Feature Branch</h3>

<p>Let&#8217;s practice good source control and start a feature branch:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout -b implement-email-addresses</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now we&#8217;re ready to work!</p>

<h3>Writing a Test: A Contact Has Many Email Addresses</h3>

<p>In your <code>person_spec.rb</code> refer to the existing example &quot;has an array of phone numbers&quot; and create a similar example for email addresses. Verify that the test fails when you run <code>bundle exec rspec</code>.</p>

<h3>Creating the Model</h3>

<p>Use the <code>scaffold</code> generator to scaffold a model named <code>EmailAddress</code> which has a string field named <code>address</code> and an integer field named <code>person_id</code>.</p>

<p>If you got your <code>rails generate</code> command messed up, go to your terminal window and hit the arrow-up key to get the command that was wrong, and then change <code>rails generate</code> to <code>rails destroy</code>. The files previously generated will be removed.</p>

<p>Run <code>bundle exec rake db:migrate db:test:prepare</code> then ensure that your test still
isn&#8217;t passing with <code>bundle exec rspec</code>.</p>

<h3>Setting Relationships</h3>

<p>Open the <code>Person</code> model and declare a <code>has_many</code> relationship for <code>email_addresses</code>. Open the <code>EmailAddress</code> model and declare a <code>belongs_to</code> relationship with <code>Person</code>.</p>

<p>Now run your tests. If you have 0 failures, and several pending specs <em>commit your changes</em>.</p>

<h3>Adding Model Tests and Validations for Email Addresses</h3>

<p>Let&#8217;s add some quality controls to our <code>EmailAddress</code> model.</p>

<ul>
<li>Open the <code>email_address_spec.rb</code></li>
<li>Delete the pending example</li>
<li>Add a <code>let</code> block named <code>email_address</code> that returns <code>EmailAddress.new</code></li>
<li>Add an example <code>it 'is valid'</code> to check that the <code>email_address</code> in the <code>let</code> block is valid</li>
<li>Look at the example &quot;is invalid without a first_name&quot; in <code>person_spec.rb</code> and create a similar example in <code>email_address_spec</code> which makes sure an <code>EmailAddress</code> is not valid without an address</li>
<li>Run your tests and make sure it <em>fails</em></li>
<li>Add a validation to ensure that the <code>address</code> attribute <code>EmailAddress</code> is present</li>
<li>Run your tests and see that your <code>it 'is valid'</code> test fails.</li>
<li>Update the <code>let</code> block giving your <code>EmailAddress</code> and <code>address</code>.</li>
<li>Run the tests and see that they pass.</li>
<li>Update the controller spec and get the pending tests to pass.</li>
<li><p>Commit.</p></li>
<li><p>Write a test to check that an <code>EmailAddress</code> isn&#8217;t valid unless it has a <code>person_id</code></p></li>
<li><p>See it fail.</p></li>
<li><p>Update the model to validate the presence of that field.</p></li>
<li><p>Run the tests, and see the <code>it 'is valid'</code> test fail as well as several controller specs.</p></li>
<li><p>Update the <code>valid_attributes</code> method in the controller specs.</p></li>
<li><p>Update the <code>let</code> block in the email address spec.</p></li>
<li><p>Run your tests and make sure it <em>passes</em></p></li>
</ul>

<p>If you&#8217;re green, go ahead and check in those changes.</p>

<h3>Completing Email Addresses</h3>

<p>Now let&#8217;s shift over to the integration tests.</p>

<h4>Displaying Email Addresses</h4>

<p>Before you play with displaying email addresses, create a few of them manually in the console.</p>

<ul>
<li>Open the <code>person_view_spec.rb</code></li>
<li>Wrap all the existing tests, including the <code>before</code> block in a <code>describe</code> block for phone numbers.</li>
<li>Create a new <code>describe</code> for the email addresses.</li>
<li>Create a <code>before</code> block within the new <code>describe</code> block that adds a couple of email addresses to the person and visits the person page.</li>
<li>Write a test that looks for LIs for each address. Try using this:</li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="s1">&#39;SOME_EMAIL_ADDRESS&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<ul>
<li>Make sure the test <em>fails</em>.</li>
<li>Add a UL to the person&#8217;s <code>show</code> template that renders a list of <code>email_addresses</code>.</li>
</ul>

<p>Tests should be green here, so check in your changes. Then continue&#8230;</p>

<h4>Create Email Address Link</h4>

<ul>
<li>Write a test named <code>&quot;has an add email address link&quot;</code> that looks for a link with ID <code>new_email_address</code>, clicks it, and verifies that it goes to the <code>new_email_address_path</code></li>
<li>Verify that it <em>fails</em></li>
<li>Add the link to the <code>show</code> page</li>
<li>Verify that it <em>passes</em></li>
</ul>

<p>If everything passes, check in your changes.</p>

<h4>Email Address Creation Workflow</h4>

<ul>
<li>Write a test that clicks the link with the id <code>new_email_address</code>, fills in the form with an email address, clicks the submit button, and expects to be back on the person page with the new email address listed.</li>
<li>Make sure the test is failing.</li>
<li>Make the spec pending while we drop into a lower level and fix this</li>
<li>Open up the email addresses controller specs</li>
<li>change the <code>it &quot;redirects to the created email_address&quot;</code> spec
so that it redirects to the email address&#8217;s person. You&#8217;ll need to create the related person.</li>
<li>see it fail</li>
<li>fix the controller</li>
<li>see the other specs fail</li>
<li>fix the specs</li>
<li>go back to the <code>person_view_spec</code> and remove the pending declaration</li>
<li>run the tests and see that it is still failing. When trying to create an email address, the form is failing to submit, because we haven&#8217;t connected it to a person.</li>
<li>Make the failing spec pending</li>
<li>Update the test in <code>person_view_spec</code> that has the link to add new email addresses, and make sure that it expects the <code>current_url</code> to be the url containing the <code>person_id</code>.</li>
<li>Remove the pending declaration on the test that was failing, and see that it is <em>still</em> failing.</li>
<li>Go to the controller and pass the <code>person_id</code> to the new <code>EmailAddress</code></li>
<li>Finally, the test passes.</li>
<li>Go ahead and hide the <code>person_id</code> in the form.</li>
</ul>

<p>Commit your changes.</p>

<ul>
<li>now do the same for the update and destroy actions as well</li>
</ul>

<p>When you&#8217;re green, check in your changes.</p>

<h3>Ship it!</h3>

<p>Let&#8217;s ship this feature:</p>

<ul>
<li>Switch back to your master branch with <code>git checkout master</code></li>
<li>Merge in the feature branch with <code>git merge implement-email-addresses</code></li>
<li>Throw it on Heroku with <code>git push heroku master</code></li>
<li>Run your migrations with <code>heroku run rake db:migrate</code></li>
</ul>

<h2>I4: Tracking Companies</h2>

<p>Our app can track people just fine, but what about companies?  What&#8217;s the difference between a company and person?  The main one, for now, is that a person has a first name and last name, while a company will just have one name.</p>

<h3>Thinking about the Model</h3>

<p>As you start to think about the model, it might trigger your instinct for inheritance. The most common inheritance style is Single Table Inheritance (STI) where you would store both people and companies into a table named <em>contacts</em>, then have a model for each that stores data in that table.</p>

<div class="note">
  <p>STI has always been controversal, and every time I&#8217;ve used it, I&#8217;ve regretted it. For that reason, I ban STI!</p>
</div>

<p>Instead we&#8217;ll build up companies in the most simplistic way: duplicating a lot of code. Once we see where things are duplicated, we&#8217;ll extract them out and get the code DRY. A robust test suite will permit us be aggressive in our refactoring.</p>

<p>In the end, we&#8217;ll have clean, simple code that follows <em>The Ruby Way</em>.</p>

<h3>Start a Feature Branch</h3>

<p>It&#8217;s always a good practice to develop on a branch:</p>

<ul>
<li><code>git checkout -b implement-companies</code></li>
</ul>

<h3>Starting up the Company Model</h3>

<p>Use the <code>scaffold</code> generator to create a <code>Company</code> that just has the attribute <code>name</code>.</p>

<p>Run <code>rake db:migrate</code> to update your database.</p>

<p>Run your tests, make sure there are no failures (pending are OK), then check your code into git.</p>

<h3>Company Phone Numbers</h3>

<p>Then we want to add phone numbers to the companies. We already have a <code>PhoneNumber</code> model, a form, and some views. We can reuse much of this&#8230;with one problem.</p>

<p>Let&#8217;s think about the implementation later, though. Write your tests first.</p>

<h4>Starting with Model</h4>

<p>Open up the <code>company_spec.rb</code> and delete the pending example.</p>

<ul>
<li>Create a <code>let</code> block that creates a Company</li>
<li>Write an <code>is valid</code> example that tests that the company is valid</li>
<li>Make sure the tests are passing</li>
<li>Write a test to ensure that Company is not valid without a name</li>
<li>See that it fails</li>
<li>Implement the validation</li>
<li>See that the &#8216;is valid&#8217; test fails</li>
<li>Fix the <code>let</code> block</li>
<li>See that all your tests pass</li>
</ul>

<p>Commit your changes.</p>

<h4>Moving Towards Phone Numbers</h4>

<p>Now we&#8217;re rolling with some tests, so we should just bring <em>everything</em> over from <em>person_spec</em> to <em>company_spec</em>, right?  I wouldn&#8217;t.</p>

<p>Just bring over and adapt the <code>&quot;has an array of phone numbers&quot;</code> example. Run it and it&#8217;ll fail.</p>

<p><em>Now</em> we get to think about implementation. To solve this for <code>Person</code>, we said that the <code>PhoneNumber</code> would <code>belongs_to</code> a <code>Person</code> and the <code>Person</code> would <code>has_many :phone_numbers</code>. Try it again here:</p>

<ul>
<li>Express the <code>has_many :phone_numbers</code> in the <code>Company</code> model</li>
<li>Add a <code>belongs_to :company</code> in the <code>PhoneNumber</code> model</li>
<li>Run your examples and you should see <code>no such column: phone_numbers.company_id</code>.</li>
</ul>

<p>When we say that a <code>PhoneNumber</code> <code>belongs_to :company</code> we imply that the <code>phone_numbers</code> table has a column named <code>company_id</code>. This is not the case, it has a <code>person_id</code> but no <code>company_id</code>.</p>

<p>We could add another column for <code>company_id</code>, but that would imply that a single number could be attached to one <code>Person</code> <em>and</em> one <code>Company</code>. That doesn&#8217;t make sense for our contact manager.</p>

<p>What we want to do is to abstract the relationship. We&#8217;ll say that a <code>PhoneNumber</code> <code>belongs_to</code> a <em>contact</em>, and that <em>contact</em> could be a <code>Person</code> or a <code>Company</code>. This is called a polymorphic relationship.</p>

<h4>Setup for Polymorphism</h4>

<p>Our tests are still red so we&#8217;re allowed to write code. To implement a polymorphic join, the <code>phone_numbers</code> table needs to have the column <code>person_id</code> replaced with <code>contact_id</code>. Then we need a second column named <code>contact_type</code> where Rails will store the class name of the associated contact.</p>

<p>We need a database migration:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails generate migration ChangePhoneNumbersToContacts</span></code></pre></td></tr></table></div></div>
        </div>

<p>In the migration we need to:</p>

<ul>
<li>destroy all the existing <code>PhoneNumbers</code> with <code>PhoneNumber.destroy_all</code></li>
<li>remove the column <code>person_id</code></li>
<li>add a column named <code>contact_id</code> that is an <code>:integer</code></li>
<li>add a column named <code>contact_type</code> that is a <code>:string</code></li>
<li>in the <code>down</code> method, <code>raise ActiveRecord::IrreversibleMigration</code></li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ChangePhoneNumbersToContacts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">destroy_all</span>
</span><span class='line'>    <span class="n">remove_column</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="ss">:person_id</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="ss">:contact_id</span><span class="p">,</span> <span class="ss">:integer</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="ss">:contact_type</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">IrreversibleMigration</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then run the migration. Bye-bye, sample phone number data!</p>

<h4>Build the Polymorphic Relationship</h4>

<p>Run your tests and feel comforted by them <em>BLOWING UP</em>! If you significantly change your database structure like this and you don&#8217;t cause a bunch of tests to fail, be concerned about your test coverage.</p>

<p>There are far too many failing tests to tackle all of them at once. Let&#8217;s just work on the phone number model specs for now.</p>

<p>Run the tests with the following command:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/models/phone_number_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>I have four failing tests, and all of them are failing for the same reason: <code>unknown attribute: person_id</code>.</p>

<p>In the failing spec, change both references to <code>person_id</code> to <code>contact_id</code>. In the <code>let</code>, let&#8217;s add <code>contact_type: 'Person'</code>.</p>

<p>Rerun the phone number model specs.</p>

<p>Now they&#8217;re complaining that about an <code>undefined method</code>person<em>id&#8217;<code>. OK, no problem. Open up the phone number model. Update any validations that include</code>person</em>id<code>to</code>contact_id`.</p>

<p>Run the tests again, and they should be passing, but for the wrong reasons. Let&#8217;s improve our tests. We still have references to <code>person</code> that need to be changed to <code>contact</code>. When updated they should look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">PhoneNumber</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="p">{</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Jimbob&quot;</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Billy&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span> <span class="p">{</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;111-222-3333&quot;</span><span class="p">,</span> <span class="n">contact_id</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">contact_type</span><span class="p">:</span> <span class="s1">&#39;Person&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;is valid&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;is invalid without a number&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">phone_number</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_valid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;must have a reference to a contact&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">phone_number</span><span class="o">.</span><span class="n">contact_id</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_valid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;is associated with a contact&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:contact</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now we should have one failure saying <code>expected #&lt;PhoneNumber id: nil, number: &quot;111-222-3333&quot;, created_at: nil, updated_at: nil, contact_id: 1, contact_type: &quot;Person&quot;&gt; to respond to :contact</code>.</p>

<p>In the model change <code>belongs_to :person</code> to <code>belongs_to :contact, polymorphic: true</code>. Let&#8217;s also remove <code>belongs_to :company</code>. Your model should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PhoneNumber</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:number</span><span class="p">,</span> <span class="ss">:contact_id</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:contact</span><span class="p">,</span> <span class="n">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now when you run them, all the tests in the phone number model spec are passing. Let&#8217;s move on to the phone number controller specs.</p>

<p>Run just the phone number controller tests with the following command:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/controllers/phone_numbers_controller_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>We have a bunch of failures complaining about <code>unknown attribute: person_id</code>.</p>

<p>Update <code>let(:valid_attributes)</code> by replacing this attribute with our new attributes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:valid_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">number</span><span class="p">:</span> <span class="s2">&quot;MyString&quot;</span><span class="p">,</span> <span class="n">contact_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">contact_type</span><span class="p">:</span> <span class="s2">&quot;Person&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Go ahead and update all of our attribute hashes in a similar way - replace <code>person_id</code> with <code>contact_id</code> and add <code>contact_type</code>. The <code>contact_id</code> values should keep the values of the <code>person_id</code> it is replacing. With the exception of <code>invalid_attribues</code>, the <code>contact_type</code> should be <code>&quot;Person&quot;</code>. <code>invalid_attributes</code> should set <code>contact_type</code> value to <code>nil</code>. Replace any other reference to <code>person_id</code> to <code>contact_id</code> and <code>person</code> to <code>contact</code>.</p>

<p>The tests are still complaining. Open up the phone numbers controller and replace references to <code>person_id</code> to <code>contact_id</code> and <code>person</code> to <code>contact</code>.</p>

<p>I&#8217;m now seeing a new error for <em>all</em> of my tests when running them - <code>Cannot redirect to nil!</code>. If you are seeing different errors, retrace your steps and read through your code thoroughly. These errors should be happening for tests that are trying to create phone numbers.</p>

<p>The reason we are seeing this failure is due to Rails use of strong parameters in the controller. There you should see a method named <code>phone_number_params</code>. Notice any attributes missing from <code>permit? We don't have</code>:contact_type`. Go ahead and add it. These are the attributes our controller will allow to be changed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">phone_number_params</span>
</span><span class='line'>  <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:number</span><span class="p">,</span> <span class="ss">:contact_id</span><span class="p">,</span> <span class="ss">:contact_type</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the controller tests and they should be passing now. Whew! That was tough.</p>

<p>Let&#8217;s move on to the <code>person_view_spec</code>:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/features/person_view_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>We are getting <code>undefined method</code>phone<em>numbers&#8217;<code>. We need to update</code>has</em>many :phone_numbers` in our person model.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:contact</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now when we run our tests we should see different failures (confirm you don&#8217;t see <code>undefined method</code>phone_numbers&#8217;<code>). The new error is</code>ActionView::Template::Error: undefined method <code>person_id'</code>. As the error indicates, the failure is occuring in our view. In the person <code>show</code> template in the link to &#8216;Add new phone number&#8217; change <code>person_id</code> to <code>contact_id</code>. Also, add in the <code>contact_type: 'Person'</code> here.</p>

<p>This helps, but we&#8217;re still seeing the same error &#8211; what gives!? If you look closely you&#8217;ll see that the &quot;undefined method person_id&quot; error has now moved to a different place: <code>app/views/phone_numbers/_form.html.erb</code>. Recall that our feature test goes through the steps of creating and editing new phone numbers, which uses the phone numbers form. So to fix these errors we also need to update the phone number form to remove the outdated <code>person_id</code> field.</p>

<p>Open up the form template and change the <code>person_id</code> to be a <code>contact_id</code>. We also need to tell the phone number what <code>contact_type</code> to use, so let&#8217;s add a new form field for contact_type:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:contact_type</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally we need to update <code>app/controllers/phone_numbers_controller.rb</code> to use this attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="vi">@phone_number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">contact_id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:contact_id</span><span class="o">]</span><span class="p">,</span> <span class="n">contact_type</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:contact_type</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We should be down to one failure in our feature spec now. If you&#8217;re still seeing other issues, check through your <code>PhoneNumbersController</code> and phone number form to make sure you&#8217;ve swapped all the relevant instances of <code>person_id</code> to <code>contact_type</code>. Now let&#8217;s address the remaining failure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Failure/Error: expect<span class="o">(</span>page<span class="o">)</span>.to have_link<span class="o">(</span><span class="s1">&#39;Add phone number&#39;</span>, href: new_phone_number_path<span class="o">(</span>person_id: person.id<span class="o">))</span>
</span><span class='line'>  Capybara::ExpectationNotMet:
</span><span class='line'>    expected to find link <span class="s2">&quot;Add phone number&quot;</span> but there were no matches. Also found <span class="s2">&quot;Add phone number&quot;</span>, which matched the selector but not all filters.
</span></code></pre></td></tr></table></div></figure>

<p>This is because we&#8217;ve updated our links to include the new contact information (<code>contact_type</code>) in our &quot;Add phone number&quot; link, but have not updated the spec to match. Let&#8217;s do that now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;has a link to add another&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Add phone number&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">new_phone_number_path</span><span class="p">(</span><span class="n">contact_id</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">contact_type</span><span class="p">:</span> <span class="s1">&#39;Person&#39;</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The <code>person_view_spec</code> should now be passing.</p>

<p><em>Whew</em></p>

<p>Run all the tests again. What are we still missing?</p>

<p>Well, the <code>spec/views/phone_numbers/new.html.erb_spec.rb</code> has some failing tests. Let&#8217;s get those straightened out.</p>

<p>Change any reference to <code>person</code> to be <code>contact</code> and run the tests again.</p>

<p>That fixes the <code>phone_numbers/new</code> view spec. Next up is <code>spec/views/phone_numbers/edit.html.erb_spec.rb</code>. Do the same thing there. Use the same technique for the failing <code>index.html.erb_spec.rb</code> and <code>show.html.erb_spec.erb</code>. You will also need to update the views that those specs are testing in a similar way.</p>

<p>And now&#8230; finally! The only failing test is the company test that we started out with.</p>

<p>Open up the <code>app/models/company.rb</code> file and the following relationship between <code>phone_numbers</code> should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:contact</span>
</span></code></pre></td></tr></table></div></figure>

<p>Re-run all the tests. See <em>green</em> and breathe a sigh of relief. Check in your code and rejoice!</p>

<p>Now go after the pending controller tests for the companies controller spec and <em>check-in</em> your code.</p>

<p>We&#8217;re almost done here. We have some weak tests that need to be improved.</p>

<p>Let&#8217;s start with the person model.</p>

<p>There are two tests: &#8216;has an array of phone numbers&#8217; and &#8216;has an array of email addresses&#8217;. Right now they are only checking for empty arrays, but they don&#8217;t really test the relationships that they should.</p>

<p>Update these to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;responds with its created phone numbers&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s1">&#39;555-8888&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:number</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;555-8888&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s1">&#39;responds with its created email addresses&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">email_addresses</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="s1">&#39;me@example.com&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">email_addresses</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:address</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;me@example.com&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the tests and they should all pass.</p>

<p>Now, let&#8217;s update the company model spec in a similar way. Replace <code>has an array of phone numbers</code> with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;responds with its phone numbers after they&#39;re created&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">phone_number</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;333-4444&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;333-4444&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>If your tests are green, commit your changes.</p>

<h3>Integration tests for Company</h3>

<p>Take a look at the <code>person_view_spec.rb</code>. There are several examples that would apply to companies, too.</p>

<p>Create a <code>company_view_spec.rb</code> and bring over anything related to phone numbers. Refactor the <code>before</code> block and the copied tests to reflect companies.</p>

<p>Make all of the tests except the first one pending so we can deal with this one test at a time.</p>

<h4>Implementing Lists, Links, and Partials</h4>

<p>Run your tests with</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/features/company_view_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>The first test I have is about displaying phone numbers, and it is failing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>1<span class="o">)</span> the company view phone numbers shows the phone numbers
</span><span class='line'>     Failure/Error: expect<span class="o">(</span>page<span class="o">)</span>.to have_content<span class="o">(</span>phone.number<span class="o">)</span>
</span><span class='line'>       expected to find text <span class="s2">&quot;555-1234&quot;</span> in <span class="s2">&quot;Name: ACME Edit | Back&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>That&#8217;s fair, since we haven&#8217;t written any code for that behavior yet.</p>

<p>Open up the <code>app/views/companies/show.html.erb</code>. Copy and paste the phone number section from the <code>app/views/people/show.html.erb</code> template, edit it to taste, and re-run the tests.</p>

<p>Open up the <code>company_view_spec.rb</code> file and remove the <code>pending</code> declaration in the next test.</p>

<p>Run the specs with <code>bundle exec rspec spec/features/company_view_spec.rb</code>. Go ahead and copy/paste from the <code>people/show</code> file to get the test to pass.</p>

<p>Remove each <code>pending</code> declaration from the specs and copy and copy, paste, and adapt any code from the person&#8217;s phone number implementation to make it pass.</p>

<p>We&#8217;ll deal with the duplication a bit later.</p>

<h4>Check it in!</h4>

<p>Run all the tests and if everything is green, commit your changes.</p>

<h3>Companies and Email Addresses</h3>

<p>You&#8217;ve done it for phone numbers, now go through the whole process to make email addresses work for companies.</p>

<p>Start with the model spec for Company that says that the company responds with its created email addresses.</p>

<p>Then implement the polymorphism for <code>EmailAddress</code> to make it work.</p>

<p>Don&#8217;t freak out if a bunch of tests are failing, just pick a single spec file and run the specs for that file, ignoring all the others. Get one test passing at a time.</p>

<p>If it helps, mark the failing specs as pending by using <code>xit</code> for the <code>it</code> blocks. Remove one <code>x</code> at a time and get the test to pass.</p>

<p>Once you&#8217;re green, add integration tests for email addresses to the <code>company_view_spec.rb</code>. Deal with one spec at a time until everything works.</p>

<p>That&#8217;s TDD for you. Now before you take a nap, poke around in the web interface. I think we&#8217;ve got everything working.</p>

<h3>Ship It</h3>

<ul>
<li>You&#8217;re green, so check in your code to the feature branch.</li>
<li>Switch back to your master branch and merge in your feature branch. If your forget the branch&#8217;s name, try <code>git branch</code> to list them.</li>
<li>Push it to Heroku</li>
<li>Run your migrations</li>
<li>&#8230;</li>
<li>Profit!</li>
</ul>

<h2>I5: Removing Code</h2>

<p>Russ Olsen, in his book &quot;Eloquent Ruby,&quot; has a great line: <em>&quot;The code you don&#8217;t write never stops working.&quot;</em></p>

<p>Our app has entirely too much code. It works, so we can&#8217;t call it &quot;bad,&quot; but we can up the code quality and drop the maintenance load by refactoring.</p>

<p><em>Refactoring</em> is the process of taking working code and improving it. That might mean reducing complexity, isolating dependencies, removing duplication &#8211; anything that leaves the external functionality the same while cleaning up the internals. In my opinion, the art of refactoring is the difference between people who write computer programs and people who are programmers. But there&#8217;s a catch to refactoring&#8230;</p>

<p><em>&quot;Don&#8217;t change anything that doesn&#8217;t have [good test] coverage, otherwise you aren&#8217;t refactoring &#8211; you&#8217;re just changing [stuff].&quot;</em></p>

<p>Our app has solid test coverage since it was written through TDD. That coverage gives us permission to refactor.</p>

<h3>Start a feature branch</h3>

<p>You&#8217;re on your <code>master</code> branch. Create and check out a branch named <code>refactoring</code> where we&#8217;ll make all our changes.</p>

<h3>Helper Hitlist</h3>

<p>Running the generators is great, but they create a lot of code. There are several files we can delete right away.</p>

<p>One thing you&#8217;ll see in many Rails projects is a <code>helpers</code> folder full of blank files. One of the things I hate about helpers is the naming convention from the generators is to create one helper for each model. Instead, you most often want your helper files grouping related functions, like a <code>TimeAndDateHelper</code> or <code>CurrencyHelper</code>.</p>

<p>Many developers get tricked into thinking helper classes should be tied to models and every model should have a helper class. That&#8217;s simply not true.</p>

<p>Run the following command.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>wc app/helpers/*</span></code></pre></td></tr></table></div></div>
        </div>

<p>All the helpers have 2 lines of code in them. If you open up one of those you&#8217;ll see that those are just an empty class definition.</p>

<p>You can delete them all. Be sure to also delete the generated specs for those files.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
<span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git rm app/helpers/*</span><span class='line command'>git rm spec/helpers/*</span></code></pre></td></tr></table></div></div>
        </div>

<p>Run your tests and, if you&#8217;re green, check in the changes.</p>

<h3>Revising Controllers</h3>

<p>Open up the <code>phone_numbers_controller.rb</code>. There are all the default actions here. Do we ever <code>show</code> a single phone number?  Do we use the index to view all the phone numbers separate from their contacts?  No. So let&#8217;s delete those actions.</p>

<p>Remember to delete the corresponding views, view specs, request specs, and controller specs for the <code>index</code> and <code>show</code> actions.</p>

<p>We don&#8217;t want to expose these endpoints to the world, so let&#8217;s make sure that they&#8217;re no longer available as routes, either.</p>

<p>change the <code>resources :phone_numbers</code>, in <code>routes.rb</code>, to read as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

<p>You&#8217;re going to have to delete the corresponding routing specs as well.</p>

<p>If your tests are green, commit your changes.</p>

<p>Now do the same thing for the <code>EmailAddressesController</code></p>

<h4>About Before Actions</h4>

<p>Take a look at the email addresses controller. You should have this line near the top of the class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_action</span> <span class="ss">:set_email_address</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

<p>This will run the <code>set_email_address</code> method <em>before</em> the <code>edit</code>, <code>update</code> or <code>destroy</code> actions are run. This allows us to share code without duplication. Take a look at the <code>set_email_address</code> method to see what it is doing. Now look at the actions that are dependant on this method.</p>

<p>Experiment a little. What happens if you comment out the before action? How would you get the edit page to load without it? (To be clear, we want the before action so make sure it&#8217;s there after experimenting).</p>

<p>Also, note the <code>private</code> doesn&#8217;t have an <code>end</code> line. Any method defined after the <code>private</code> keyword in a Ruby class will be private to instances of that object. It&#8217;s common practice to make methods that get used in before actions private.</p>

<h4>Removing Blank Controller Actions?</h4>

<p>Take a look at the <code>edit</code> action. It&#8217;s totally blank. You can, then, remove the method from the controller. The <code>before_filter</code> will still be activated and the view template renders so things will work great.</p>

<p>But I don&#8217;t think it&#8217;s worth the developer cost. Not having the method in the file then having it work in the app is <em>confusing</em>. I&#8217;d recommend you just leave the stub.</p>

<h4>Playing with <code>ApplicationController</code></h4>

<p>Did you notice that all those controllers inherit from <code>ApplicationController</code>?  We&#8217;ve now got a private method in each controller that&#8217;s almost exactly the same. Could we condense them all into one method in the parent class?</p>

<p>Here&#8217;s what the method would have to do:</p>

<ul>
<li>Figure out which controller called the method</li>
<li>Figure out the model name for that controller</li>
<li>Run the find action of that model</li>
<li>Store it into an instance variable with the right name (like <code>@person</code> or <code>@company</code>)</li>
</ul>

<p>It&#8217;s a bit of metaprogramming that took me some experimenting, and here&#8217;s what I ended up with in my <code>ApplicationController</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_resource</span>
</span><span class='line'>  <span class="n">class_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:controller</span><span class="o">].</span><span class="n">singularize</span>
</span><span class='line'>  <span class="n">klass</span> <span class="o">=</span> <span class="n">class_name</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">constantize</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">instance_variable_set</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then I call that method from <code>before_action</code> lines in each controller. The <code>before_action</code> call could be pulled into the application controller, but I think that makes the individual controllers too opaque.</p>

<h3>Removing Model Duplication</h3>

<p>If you look at the <code>Person</code> and <code>Company</code> models you&#8217;ll see there are two lines exactly duplicated in each:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:contact</span>
</span><span class='line'><span class="n">has_many</span> <span class="ss">:email_addresses</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:contact</span>
</span></code></pre></td></tr></table></div></figure>

<p>Essentially each of these models shares the concept of a &quot;contact,&quot; but we decided not to go down the dark road of STI. Instead, we should abstract their common code into a module. Right now it&#8217;s only two lines, but over time the common code will likely increase. The module will be the place for common code to live.</p>

<p>There are many opinions about where modules should live in your application tree. In this case we&#8217;re going to create a <code>Contact</code> module and it&#8217;s almost like a model, so let&#8217;s drop the file right into the models folder.</p>

<ul>
<li>Create a file <code>app/models/contact.rb</code></li>
<li>In it, define a module like this:</li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Contact</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<ul>
<li>Move the two <code>has_many</code> lines from the <code>Person</code> model into that <code>module</code></li>
<li>In their place within the <code>Person</code>, add this line:</li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">include</span> <span class="no">Contact</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests and everything will be broken. When we write a module we need to distinguish between three types of code:</p>

<ul>
<li>code that should be run in the containing class when the module is included</li>
<li>methods that should be defined on the including class (like Person.first)</li>
<li>methods that should be defined for instances of the including class (like Person.first.name)</li>
</ul>

<p>The normal Ruby syntax to accomplish these jobs is a little ugly. Starting in Rails 3, there&#8217;s a feature library that cleans up the implementation of modules. We use it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Contact</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Any code defined inside the <code>included</code> block will be run on the class when the module is included. Any methods defined in the <code>ClassMethods</code> submodule will be defined on the including class. And methods defined directly in the module will be attached to instances of the class.</p>

<p>Where should your two <code>has_many</code> lines go?  Figure it out on your own and use your tests to prove that it works. When you&#8217;re <em>green</em>, check it in. (hint: check out the docs if you get stuck: <a href="http://api.rubyonrails.org/classes/ActiveSupport/Concern.html">http://api.rubyonrails.org/classes/ActiveSupport/Concern.html</a>)</p>

<h3>Cutting Down View Redundancy</h3>

<p>Do you remember copying and pasting some view code?  I told you to do it, so don&#8217;t feel guilty.</p>

<h4>Extracting view partials.</h4>

<p>Partials are view templates which represent reuseable chunks of markup and display logic. They&#8217;re especially useful for representing similar data in multiple places in your application, as we are doing now with phone numbers and email addresses. Let&#8217;s extract some of this duplicated markup into partials.</p>

<p>Create a partial <code>app/views/phone_numbers/_phone_numbers.html.erb</code>. Copy the phone number list from the <code>companies/show.html.erb</code> template into the partial, and then replace the list in the list in the companies template with a call to render that partial:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;phone_numbers/phone_numbers&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your company view integration tests again:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/features/company_view_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>The test passes.</p>

<p>We&#8217;ve only fixed half the duplication. Run the person view specs to make sure that they pass:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>bundle exec rspec spec/features/person_view_spec.rb</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now open up the <code>people/show.html.erb</code> file and replace the phone number list with a call to render the new partial:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;phone_numbers/phone_number&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>Run the person view tests again, and all of them are failing with the following error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Failure/Error: visit person_path<span class="o">(</span>person<span class="o">)</span>
</span><span class='line'>ActionView::Template::Error:
</span><span class='line'> undefined method <span class="sb">`</span>phone_numbers<span class="err">&#39;</span> <span class="k">for </span>nil:NilClass
</span></code></pre></td></tr></table></div></figure>

<p>Open up the <code>phone_numbers/_phone_numbers.html.erb</code> partial. We have an explicit reference to the <code>@company</code> in there, but now we&#8217;re rendering the partial from the person context, <code>@company</code> is not defined, but <code>@person</code> is.</p>

<p>When we write ruby code, we always aim to keep our classes as independent and decoupled as possible. The same principle applies to writing good, reusable view templates. Here we need to decouple the phone numbers partial from the surrounding context, and one easy way to do this is by having the list of phone numbers passed in explicitly as a template local variable.</p>

<p>Luckily rails facilitates this by allowing us to pass an arbitrary hash of local variables to the render method.</p>

<p>First, in <code>phone_numbers/_phone_numbers.html.erb</code> delete <code>@company</code>.</p>

<p>Then, in <code>people/show.html.erb</code> change the call to render to be as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;phone_numbers/phone_numbers&#39;</span><span class="p">,</span> <span class="ss">:phone_numbers</span> <span class="o">=&gt;</span> <span class="vi">@person</span><span class="o">.</span><span class="n">phone_numbers</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>

<p>And finally, in <code>companies/show.html.erb</code>, update the call to render to send in the <code>@company.phone_numbers</code>.</p>

<p>Run all the tests. Everything should be passing.</p>

<h4>Extracting an Email Addresses Partial</h4>

<p>Then repeat the exact same process for the email addresses.</p>

<h4>Check It In</h4>

<p>If your tests are green, check in the code.</p>

<h3>Simplifying Views</h3>

<p>Our views have a ton of markup in them and the output is <em>ugly</em>!  Let&#8217;s cut it down.</p>

<h4>Companies &amp; People Index</h4>

<p>Open the <code>app/views/companies/index.html.erb</code> and&#8230;</p>

<ul>
<li>Turn the three <code>td</code> elements with the &quot;Show&quot;, &quot;Edit&quot;, and &quot;Destroy&quot; links into a single <code>td</code> where each link is a list item inside a <code>ul</code> with the class name <code>actions</code></li>
<li>Add the id <code>&quot;new_company&quot;</code> to the link for the new company page</li>
</ul>

<p>Run your tests and everything should be green.</p>

<p>Now go through the <em>same process</em> for <code>app/views/people/index.html.erb</code> using the word <code>person</code> instead of <code>company</code> where appropriate. Also combine the first name and last name into a single <code>td</code> for <code>name</code>.</p>

<p>This last thing will break a test, so make sure you fix that before checking in.</p>

<h4>Company &amp; Person Show</h4>

<p>Let&#8217;s make a similar set of changes to <code>app/views/companies/show.html.erb</code>&#8230;</p>

<ul>
<li>Create a heading line to use the name of the company</li>
<li>Remove the paragraph with the company name</li>
<li>Make sure the phone numbers just renders the partial (not wrapped in a paragraph etc.)</li>
<li>Do the same for the email addresses</li>
<li>Change the actions so they&#8217;re inside <code>li</code> tags inside a <code>ul</code> with the class name <code>&quot;actions&quot;</code></li>
<li>Wrap the whole view in a div with class name <code>&quot;company&quot;</code></li>
</ul>

<p>Run your tests and they should be green. Then, <em>repeat the process</em> for <code>app/views/people/show.html.erb</code></p>

<p>When you&#8217;re green, check it in.</p>

<h4>Company &amp; Person Edit</h4>

<p>Just a few small changes to the <code>edit</code> template:</p>

<ul>
<li>Change the heading so it uses the name of the company/person</li>
<li>Change the links and the bottom to be wrapped in <code>li</code> tags inside a <code>ul</code> with classname <code>&quot;actions&quot;</code></li>
</ul>

<h3>PhoneNumber &amp; Email Address New/Edit</h3>

<p>Open the <code>email_addresses/new.html.erb</code> and change the heading from</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Editing</span> <span class="n">email_address</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>To this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;&lt;%=</span> <span class="s2">&quot;New Email Address for </span><span class="si">#{</span><span class="vi">@email_address</span><span class="o">.</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sx">%&gt;&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>View it in your browser andâ€¦what is that? You probably see something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>New Email Address for #&lt;Person:0x007f902f76f248&gt;
</span></code></pre></td></tr></table></div></figure>

<p>That person-like thing is what you get when you call the <code>to_s</code> method on an object that doesnâ€™t have a <code>to_s</code>. This is the version all objects inherit from the <code>Object</code> class.</p>

<h4>Testing a <code>to_s</code> Method</h4>

<p>We want to write some code in our models, but we don&#8217;t have permission to do that without a failing test. Pop open the <code>person_spec.rb</code> file. Then add an example like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;convert to a string with last name, first name&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;Smith, Alice&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The value on the right side will obviously depend on what value you setup in the <code>let</code> block. Run the test and it&#8217;ll go red.</p>

<h4>Implementing a <code>to_s</code></h4>

<p>Now you get to open <code>models/person.rb</code> and define a <code>to_s</code> method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">to_s</span>
</span><span class='line'>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>That should make your test pass. Go through the same process writing a test for the <code>to_s</code> of <code>Company</code> then implementing the <code>to_s</code> method.</p>

<h4>Did It Work?</h4>

<p>Flip over to your browser and you&#8217;ll see that the <code>title</code> on the new email address page should look much better. It isn&#8217;t making a test go green, though, and that makes me feel guilty. We&#8217;ve knowingly spent time implementing untested code.</p>

<p>Let&#8217;s write a quick view test. In the view spec <code>email_addresses_new.html.erb_spec.rb</code>, add this example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;shows the contact&#39;s name in the title&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">render</span>
</span><span class='line'>  <span class="n">assert_select</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="s2">&quot;New Email Address for </span><span class="si">#{</span><span class="n">email_address</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">email_address</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>You will probably get some errors about <code>email_address</code> being undefined. Lets fill in this as well as a person with some <code>let</code>s at the top of the file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="p">{</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Smith&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:email_address</span><span class="p">)</span> <span class="p">{</span> <span class="no">EmailAddress</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:contact_id</span> <span class="o">=&gt;</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:contact_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;Person&quot;</span><span class="p">,</span> <span class="ss">:address</span> <span class="o">=&gt;</span> <span class="s2">&quot;MyString&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">assign</span><span class="p">(</span><span class="ss">:email_address</span><span class="p">,</span> <span class="n">email_address</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now our example should pass since we already implemented the <code>to_s</code> in <code>person.rb</code>. Try a little <em>&quot;Comment Driven Development&quot;</em>:</p>

<ul>
<li>Comment out the <code>to_s</code> method in <code>person.rb</code></li>
<li>Run the test and see it <em>fail</em></li>
<li>Un-comment the <code>to_s</code></li>
<li>See it <em>pass</em>!</li>
</ul>

<p>Now in the &quot;edit&quot; view spec (<code>spec/views/email_addresses/edit.html.erb_spec.rb</code>), implement a similar example for the <code>edit</code> form, then change the view template to make it work.</p>

<h4>More Form Tests &amp; Tweaks</h4>

<p>Implement the same technique on&#8230;</p>

<ul>
<li>the <code>new</code> template for phone numbers</li>
<li>the <code>edit</code> template for phone numbers</li>
</ul>

<h4>Making Use of the <code>to_s</code> Method</h4>

<p>Lastly, consider searching your other views and simplifying calls to <code>@company.name</code> or <code>@person.first_name</code> with <code>@person.last_name</code> to just use the implicit <code>to_s</code>.</p>

<h3>Ship It</h3>

<p>We&#8217;re done with this iteration and your tests are green &#8211; it&#8217;s time to ship it.</p>

<p>Make sure everything&#8217;s checked in on your feature branch, <code>checkout</code> master, <code>merge</code> in the branch, then <code>push</code> it to Heroku. Check out the results in your browser. Look at the beauty of those minus signs and many deleted files.</p>

<h2>EI6: Supporting Users</h2>

<p><strong>Note: the iterations six and seven need revision to conform with Iterations 1-5. The step-by-step instructions below will need debugging, but the concepts are the same.</strong></p>

<p>What&#8217;s the point of a web application if only one person can use it?  Let&#8217;s make our system support multiple users. There are three pieces to making this happen:</p>

<ul>
<li><em>Authentication</em> - Establish identity</li>
<li><em>Ownership</em> - Attach data records to user records</li>
<li><em>Authorization</em> - Control who is allowed to do what</li>
</ul>

<h3>Background on Authentication</h3>

<p>There have been about a dozen popular methods for authenticating Rails applications over the past five years.</p>

<p>The most popular right now is <a href="https://github.com/plataformatec/devise">Devise</a> because it makes it very easy to get up and running quickly. The downside is that the implementation uses very aggressive Ruby and metaprogramming techniques which make it very challenging to customize.</p>

<p>In the past I&#8217;ve been a fan of <a href="https://github.com/binarylogic/authlogic">AuthLogic</a> because it takes a very straightforward model/view/controller approach, but it means you have to write a lot of code to get it up and running.</p>

<p>As we learn more about constructing web applications there is a greater emphasis on decoupling components. It makes a lot of sense to depend on an external service for our authentication, then that service can serve this application along with many others.</p>

<h3>Why OmniAuth?</h3>

<p>The best application of this concept is the <a href="https://github.com/intridea/omniauth">OmniAuth</a>. It&#8217;s popular because it allows you to use multiple third-party services to authenticate, but it is really a pattern for component-based authentication. You could let your users login with their Twitter account, but we can also build our own OmniAuth provider that authenticates all your companies&#8217; apps. Maybe you can use the existing LDAP provider to hook into ActiveDirectory or OpenLDAP, or make use of the Google Apps interface?</p>

<p>Better yet, OmniAuth can handle multiple concurrent strategies, so you can offer users multiple ways to authenticate. Your app is just built against the OmniAuth interface, those external components can come and go.</p>

<h3>Starting a Feature Branch</h3>

<p>Before we start writing code, let&#8217;s create a branch in our repository.</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>git checkout -b add-authentication</span></code></pre></td></tr></table></div></div>
        </div>

<p>Now you&#8217;re ready to write code.</p>

<h3>Getting Started with OmniAuth</h3>

<p>The first step is to add the dependency to your <code>Gemfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth-twitter&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then run <code>bundle</code> from your terminal.</p>

<p>OmniAuth runs as &quot;Rack Middleware&quot; which means it&#8217;s not really a part of our app, it&#8217;s a thin layer between our app and the client. To instantiate and control the middleware, we need an initializer. Create a file <code>/config/initializers/omniauth.rb</code> and add the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="s2">&quot;EZYxQSqP0j35QWqoV0kUg&quot;</span><span class="p">,</span> <span class="s2">&quot;IToKT8jdWZEhEH60wFL94HGf4uoGE1SqFUrZUR34M4&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>What is all that garbage?  Twitter, like many API-providing services, wants to track who&#8217;s using it. They accomplish this by distributing API accounts. Specifically, they use the OAuth protocol which requires a &quot;comsumer key&quot; and a &quot;consumer secret.&quot;  If you want to build an application using the Twitter API you&#8217;ll need to <a href="https://dev.twitter.com/apps">register and get your own credentials</a>. For this tutorial, I&#8217;ve registered a sample application and given you my key/secret above.</p>

<h3>Trying It Out</h3>

<p>You need to <em>restart your server</em> so the new library and initializer are picked up. In your browser go to <a href="http://127.0.0.1:8080/auth/twitter"><a href="http://127.0.0.1:8080/auth/twitter">http://127.0.0.1:8080/auth/twitter</a></a> and, after a moment or two, you should see a Twitter login page. Login to Twitter using any account, then you should see a <em>Routing Error</em> from your application. If you&#8217;ve got that, then things are on the right track.</p>

<p>If you get to this point and encounter a <em>401 Unauthorized</em> message there is more work to do. You&#8217;re probably using your own API key and secret. You need to go into the <a href="https://dev.twitter.com/apps/">settings on Twitter for your application</a>, and add <a href="http://127.0.0.1">http://127.0.0.1</a> as a registered callback domain. I also add <a href="http://0.0.0.0">http://0.0.0.0</a> and <a href="http://localhost">http://localhost</a> while I&#8217;m in there. Now give it a try and you should get the <em>Routing Error</em></p>

<h3>Handling the Callback</h3>

<p>The way this authentication works is that your app redirects to the third party authenticator, the third party processes the authentication, then it sends the user back to your application at a &quot;callback URL&quot;. Twitter is attempting to send the data back to your application, but your app isn&#8217;t listening at the default OmniAuth callback address, <strong>/auth/twitter/callback</strong>. Let&#8217;s add a route to listen for those requests.</p>

<p>Open <code>app/config/routes.rb</code> and add this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get</span> <span class="s1">&#39;/auth/:provider/callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;sessions#create&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Re-visit <a href="http://localhost:8080/auth/twitter">http://localhost:8080/auth/twitter</a>, it will process your already-existing Twitter login, then redirect back to your application and give you <em>Uninitialized Constant SessionsController</em>. Our router is attempting to call the <code>create</code> action of the <code>SessionsController</code>, but that controller doesn&#8217;t exist yet.</p>

<h3>Creating a Sessions Controller</h3>

<p>Create a controller at <code>app/controllers/sessions_controller.rb</code> that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">render</span> <span class="n">text</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Revisit <a href="http://localhost:8080/auth/twitter">/auth/twitter</a> and, once it redirects to your application, you should see a bunch of information provided by Twitter about the authenticated user! Now we just need to figure out what to <em>do</em> with all that.</p>

<h3>Creating a User Model</h3>

<p>Even though we&#8217;re using an external service for authentication, we&#8217;ll still need to keep track of user objects within our system. Let&#8217;s create a model that will be responsible for that data.</p>

<p>As you saw, Twitter gives us a ton of data about the user. What should we store in our database?  The minimum expectations for an OmniAuth provider are three things:</p>

<ul>
<li><em>provider</em> - A string name uniquely identifying the provider service</li>
<li><em>uid</em> - An identifying string uniquely identifying the user within that provider</li>
<li><em>name</em> - Some kind of human-meaningful name for the user</li>
</ul>

<p>Let&#8217;s start with just those three in our model. From your terminal:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>$</span>
</pre></td><td class='code'><pre><code><span class='line command'>rails generate model User provider:string uid:string name:string</span></code></pre></td></tr></table></div></div>
        </div>

<p>Then update the databases with <code>rake db:migrate</code>.</p>

<h3>Creating Actual Users</h3>

<p>How you create users might vary depending on the application. For the purposes of our contact manager, we&#8217;ll allow anyone to create an account automatically just by logging in with the third party service.</p>

<p>Let&#8217;s write a test for our <code>SessionsController</code>. Make a new file <code>spec/controllers/sessions_controller_spec.rb</code>. We don&#8217;t need all of the data that came back from <code>Twitter</code>, just the data that we&#8217;re interested in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">SessionsController</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#create&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;creates a user from twitter data&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;info&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Alice Smith&#39;</span><span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;abc123&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">post</span> <span class="ss">:create</span>
</span><span class='line'>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_uid_and_provider</span><span class="p">(</span><span class="s1">&#39;abc123&#39;</span><span class="p">,</span> <span class="s1">&#39;twitter&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">&quot;Alice Smith&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run this test, and it will fail because we don&#8217;t have a route for the <code>sessions#create</code> action.</p>

<p>We do have a route that goes there, but we can&#8217;t call it from this controller test. We could add this line to the <code>config/routes.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resource</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now the test should fail because we don&#8217;t actually do anything useful in the controller action yet.</p>

<p>Go ahead and make this pass by just creating a user right there in the controller.</p>

<p>My controller looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;info&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:nothing</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>It&#8217;s ugly, but it will do for now.</p>

<p>We don&#8217;t always want to create a new user when someone logs in. They might already be in the system.</p>

<p>Let&#8217;s add a test for that case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;doesn&#39;t create duplicate users&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;info&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob Jones&#39;</span><span class="p">},</span>
</span><span class='line'>    <span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;xyz456&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="s1">&#39;xyz456&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Bob Jones&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">post</span> <span class="ss">:create</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>To get this to pass I changed my create method to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;info&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">:nothing</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We&#8217;re still not logging the user in, though. Let&#8217;s update the tests to expect the current session to have the user ID in them.</p>

<p>I&#8217;m renaming my tests to be</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;logs in a new user&#39;</span>
</span><span class='line'><span class="n">it</span> <span class="s1">&#39;logs in an existing user&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;logs in a new user&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;info&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Alice Smith&#39;</span><span class="p">},</span>
</span><span class='line'>    <span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;abc123&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">post</span> <span class="ss">:create</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_uid_and_provider</span><span class="p">(</span><span class="s1">&#39;abc123&#39;</span><span class="p">,</span> <span class="s1">&#39;twitter&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s2">&quot;logs in an existing user&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;info&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob Jones&#39;</span><span class="p">},</span>
</span><span class='line'>    <span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;xyz456&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="s1">&#39;xyz456&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Bob Jones&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">post</span> <span class="ss">:create</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now the tests fail because we don&#8217;t have a <code>current_user</code> in the controller. Let&#8217;s add a helper method for that.</p>

<p>Open up <code>app/controllers/application_controller.rb</code> and add the following to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">helper_method</span> <span class="ss">:current_user</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_user</span>
</span><span class='line'>  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test fails because when we say <code>User.find(session[:user_id])</code> this comes back as nil.</p>

<p>Let&#8217;s put the user id in the session. Go back to the sessions controller and update the <code>create</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;info&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">:nothing</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Our tests pass, but there&#8217;s a lot of logic in this controller. Let&#8217;s refactor to let the model handle most of this.</p>

<p>Open up <code>app/models/user.rb</code> and add the following to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_or_create_by_auth</span><span class="p">(</span><span class="n">auth_data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="n">auth_data</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="n">auth_data</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">auth_data</span><span class="o">[</span><span class="s2">&quot;info&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">auth_data</span><span class="o">[</span><span class="s2">&quot;info&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">user</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>To walk through that step by step&#8230;
* Look in the users table for a record with this provider and uid combination. If it&#8217;s found, you&#8217;ll get it back. If it&#8217;s not found, a new record will be created and returned
* Compare the user&#8217;s name and the name in the auth data. If they&#8217;re different, either this is a new user and we want to store the name or they&#8217;ve changed their name on the external service and it should be updated here. Then save it.
* Either way, return the user</p>

<p>Now, back to <code>SessionsController</code>. Update the action to use the new method on the User class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_or_create_by_auth</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">:nothing</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally, we&#8217;re going to want to redirect to send them to the <code>root_path</code> after login:</p>

<p>Add a test for this behavior:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;redirects to the companies page&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;info&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Charlie Allen&#39;</span><span class="p">},</span>
</span><span class='line'>    <span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;prq987&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;twitter&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="s1">&#39;prq987&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Charlie Allen&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">post</span> <span class="ss">:create</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is horrible! All that setup, just because we want to test the redirect? Right now there&#8217;s no way around it. Maybe we can figure out a better way later.</p>

<p>Ok, the test fails, because it doesn&#8217;t know about the <code>root_path</code>. If haven&#8217;t already, add a root path to <code>routes.rb</code> - <code>root to: 'companies#index'</code> .</p>

<p>Finally, we&#8217;re failing for the right reason: we&#8217;re expecting a redirect, but we&#8217;re getting a render.</p>

<p>Update the controller action:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_or_create_by_auth</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>  <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="n">notice</span><span class="p">:</span> <span class="s2">&quot;Logged in as </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>To get the notice to display, add the following code just above the <code>yield</code> tag in <code>application.html.erb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% flash.each </span><span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%= content_tag :div, msg, class: &quot;alert alert-info&quot; %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This gets the test to pass. We&#8217;ll leave it at this for now.</p>

<p>Now visit <a href="http://localhost:8080/auth/twitter">/auth/twitter</a> and you should eventually be redirected to your Companies listing and the flash message at the top will show a message saying that you&#8217;re logged in.</p>

<h3>UI for Login/Logout</h3>

<p>That&#8217;s exciting, but now we need links for login/logout that don&#8217;t require manually manipulating URLs.</p>

<p>We need a test that will make us put a login link in the page.</p>

<p>Create a new file <code>spec/features/authentication_spec.rb</code> and put this code in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rails&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;the application&#39;</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="ss">:feature</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;when logged out&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">visit</span> <span class="n">root_path</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;has a login link&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test fails because we don&#8217;t have a <code>root_path</code>. Add this to your <code>config/routes.rb</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span> <span class="n">to</span><span class="p">:</span> <span class="s1">&#39;site#index&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now the test is failing because we don&#8217;t have a method <code>login_path</code>.</p>

<p>Just because we&#8217;re following the REST convention doesn&#8217;t mean we can&#8217;t also create our own named routes. The view snipped we wrote is attempting to link to <code>login_path</code>, but our application doesn&#8217;t yet know about that route.</p>

<p>Open <code>/config/routes.rb</code> and add a custom route:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">match</span> <span class="s2">&quot;/login&quot;</span> <span class="o">=&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/auth/twitter&quot;</span><span class="p">),</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:login</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally, the test is failing because we don&#8217;t have a login link in the page.</p>

<p>Anything like login/logout that you want visible on every page goes in the layout.</p>

<p>Open <code>app/views/layouts/application.html.erb</code> and you&#8217;ll see the framing for all our view templates. Let&#8217;s add in the following right above the <code>yield</code> statement:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;account&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Login&quot;</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>It&#8217;s still failing. What the heck?</p>

<p>It turns out, we still have the <code>public/index.html</code> file hanging around so the root path will redirect to &#8216;/&#8217;, but the application won&#8217;t even bother looking up routes, it will simply show the <code>public/index.html</code> page.</p>

<p>Go ahead and <code>git rm public/index.html</code>.</p>

<p>Now we get a new error <code>uninitialized constant SiteController</code>. Let&#8217;s create a new file <code>app/controllers/site_controller.rb</code> and put the following code in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SiteController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now the tests complain that there&#8217;s no index action. Add one.</p>

<p>Next we get a complaint about a missing template. Make a new directory <code>app/views/site</code> and add an empty <code>index.html.erb</code> file to it.</p>

<p>Finally, that gets the test to pass. Now we need to show the logout link if we&#8217;re logged in.</p>

<p>Add a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s1">&#39;when logged in&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">visit</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;has a logout link&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Logout&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">logout_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The tests give us an error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>undefined local variable or method `logout_path&#39;
</span></code></pre></td></tr></table></div></figure>

<p>Fix that by adding a route:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">delete</span> <span class="s2">&quot;/logout&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sessions#destroy&quot;</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:logout</span>
</span></code></pre></td></tr></table></div></figure>

<p>To get the test to pass, expand the &#8216;account&#8217; section in the application layout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;account&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Login&quot;</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Logout&quot;</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logout&quot;</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This works, but we&#8217;re always showing both the login and the logout link. Let&#8217;s make sure that we only show the link that we need.</p>

<p>First, let&#8217;s add a test to the <code>when logged out</code> context:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;does not link to logout&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Logout&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">logout_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test fails, naturally.</p>

<p>Let&#8217;s only show the logout link if we&#8217;re logged in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;account&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Login&quot;</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Logout&quot;</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logout&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now our &#8216;logged in&#8217; context is failing, because we aren&#8217;t actually logged in.</p>

<p>We can&#8217;t just access the session, because we&#8217;re using Capybara here, and that isn&#8217;t meant to give you access to the internals of your app.</p>

<p>Going through twitter to log in is going to be too painful, so let&#8217;s create a fake login action that just these tests have access to.</p>

<p>At the top of this page, create a controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rails&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FakeSessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;the application&#39;</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="ss">:feature</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then change the &#8216;logged in&#8217; context to set up the routes we need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s1">&#39;when logged in&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">root</span> <span class="n">to</span><span class="p">:</span> <span class="s1">&#39;site#index&#39;</span>
</span><span class='line'>      <span class="n">get</span> <span class="s1">&#39;/fake_login&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;fake_sessions#create&#39;</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:fake_login</span>
</span><span class='line'>      <span class="n">match</span> <span class="s1">&#39;/login&#39;</span> <span class="o">=&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/auth/twitter&#39;</span><span class="p">),</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:login</span>
</span><span class='line'>      <span class="n">delete</span> <span class="s2">&quot;/logout&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sessions#destroy&quot;</span><span class="p">,</span> <span class="n">as</span><span class="p">:</span> <span class="ss">:logout</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Jane Doe&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">visit</span> <span class="n">fake_login_path</span><span class="p">(</span><span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">reload_routes!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;has a logout link&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Logout&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">logout_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This gets our tests passing again.</p>

<p>Add another test to the &#8216;logged in&#8217; context:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;does not have a login link&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>This fails. Make it pass by updating the account section in the layout.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;account&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Logout&quot;</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logout&quot;</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Login&quot;</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>There, it works. Run all your tests, and if they&#8217;re passing check it all in.</p>

<h3>Implementing Logout</h3>

<p>Our login works great, but we can&#8217;t logout!  When you click the logout link it&#8217;s attempting to call the <code>destroy</code> action of <code>SessionsController</code>. Let&#8217;s implement that.</p>

<ul>
<li>Open <code>sessions_controller_spec</code></li>
<li>Write a test that has a user id in the session, hits the destroy action of the sessions controller, and asserts that you no longer have a user id in the session.</li>
<li>Make the test pass.</li>
</ul>

<p>I had to update the before filter in the sessions controller spec to include the <code>:destroy</code> route:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">resource</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>And then my test calls that route like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">delete</span> <span class="ss">:destroy</span>
</span></code></pre></td></tr></table></div></figure>

<ul>
<li>Write another test that asserts that the user gets redirected to the root path.</li>
</ul>

<h3>Ship It</h3>

<p>If all your tests are passing, hop over to a terminal and <code>add</code> your files, <code>commit</code> your changes, <code>merge</code> the branch, and <code>push</code> it to Heroku.</p>

<h2>EI7: Adding Ownership</h2>

<p>We&#8217;ve got users, but they all share the same contacts. That obviously won&#8217;t work. We need to rethink our data model to attach contacts to a <code>User</code>.</p>

<p>Let&#8217;s start with some tests. Open up <code>user_spec.rb</code>, delete the pending spec, and add this example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s1">&#39;has associated people&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">people</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_instance_of</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>If you run your tests that test will fail because <code>people</code> is undefined for a <code>User</code>.</p>

<p>Open your <code>User</code> model and express a <code>has_many</code> relationship to <code>people</code>.</p>

<p>Re-run your tests. They should be passing.</p>

<h3>Setting up a Factory</h3>

<p>So far each of our test files has been making the objects it&#8217;ll need for the tests. If now decide that a <code>Person</code> had a required attribute of <code>title</code>, we&#8217;d have to update several spec files to create the objects properly.</p>

<p>This duplication makes our tests more fragile than they should be. We need to introduce a factory.</p>

<p>The most common libraries for test factories are <a href="https://github.com/thoughtbot/factory_girl">FactoryGirl</a> and <a href="https://github.com/notahat/machinist">Machinist</a>. Each of them has hit a rough patch of maintenance, though, which guided me towards a third option.</p>

<p>Let&#8217;s use <a href="https://github.com/paulelliott/fabrication">Fabrication</a> which is more actively maintained. Open up your <strong>Gemfile</strong> and add a dependency on <code>&quot;fabrication&quot;</code> in the test/development environment. Run <code>bundle</code> to install the gem.</p>

<p>We can also change the behavior of Rails generators to create fabrication patterns instead of normal fixtures. Open up <code>config/application.rb</code>, scroll to the bottom, and just before the config section closes, add this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">generators</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">test_framework</span>      <span class="ss">:rspec</span><span class="p">,</span> <span class="n">fixture</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">fixture_replacement</span> <span class="ss">:fabrication</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Using Fabrication</h3>

<p>Now we need to make our fabricator. Create a folder <code>spec/fabricators/</code> and in it create a file named <code>user_fabricator.rb</code>. In that file add this definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fabricator</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">name</span> <span class="s2">&quot;Sample User&quot;</span>
</span><span class='line'>  <span class="n">provider</span> <span class="s2">&quot;twitter&quot;</span>
</span><span class='line'>  <span class="n">uid</span> <span class="p">{</span><span class="no">Fabricate</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="ss">:uid</span><span class="p">)}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then go back to <code>user_spec.rb</code> and replace the implementation of the <code>let</code> block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now your tests fail because you don&#8217;t have a user_id column on the people table.</p>

<p>Now your tests will fail because we&#8217;re missing the relationship in the database. Generate a migration to add the integer column named &quot;user_id&quot; to the people table. Run the migration, run your examples again, and they should pass.</p>

<h4>Working on the Person</h4>

<p>Let&#8217;s take a look at the <code>Person</code> side of this relationship. Open the <code>person_spec.rb</code>. First, let&#8217;s refactor the <code>let</code> block to use a Fabricator.</p>

<p>Create the <code>spec/fabricators/person_fabricator.rb</code> file and add this definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fabricator</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">first_name</span> <span class="s2">&quot;Alice&quot;</span>
</span><span class='line'>  <span class="n">last_name</span> <span class="s2">&quot;Smith&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
Then in the `let` block of `person_spec.rb`, use the fabricator like this:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests and make sure the examples are still passing.</p>

<h4>Testing that a Person Belongs to a User</h4>

<p>Add an example checking that the <code>person</code> is the child of a <code>User</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;is a child of the user&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_instance_of</span><span class="p">(</span><span class="no">User</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The test fails because the person doesn&#8217;t have a method name user.</p>

<p>Add the <code>belongs_to</code> association in <code>Person</code>.</p>

<p>Run the tests. Now they fail with this message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>expected nil to be an instance of User
</span></code></pre></td></tr></table></div></figure>

<p>This is really testing two things: that the person responds to the method call <code>user</code> and that the response is a <code>User</code>.</p>

<h4>Revising the Person Fabricator</h4>

<p>We need to work more on the fabricator. When we create a <code>Person</code>, we need to attach it to a <code>User</code>. It&#8217;s super easy because we&#8217;ve already got a fabricator for <code>User</code>. Open the <code>person_fabricator.rb</code> and add the line <code>user</code> so you have this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fabricator</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">first_name</span> <span class="s2">&quot;Alice&quot;</span>
</span><span class='line'>  <span class="n">last_name</span> <span class="s2">&quot;Smith&quot;</span>
</span><span class='line'>  <span class="n">user</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now when a <code>Person</code> is fabricated it will automatically associate with a user. Run your tests and they should pass.</p>

<h4>More From the User Side</h4>

<p>Let&#8217;s check that when a <code>User</code> creates <code>People</code> they actually get associated. Try this example in <code>user_spec</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;builds associated people&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person_1</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">person_2</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>  <span class="o">[</span><span class="n">person_1</span><span class="p">,</span> <span class="n">person_2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">people</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="kp">include</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">people</span> <span class="o">&lt;&lt;</span> <span class="n">person</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">people</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests and it&#8217;ll pass because we&#8217;re correctly setup the association on both sides.</p>

<h4>Now for Companies</h4>

<p>Write a similar test for companies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;builds associated companies&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">company_1</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:company</span><span class="p">)</span>
</span><span class='line'>  <span class="n">company_2</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:company</span><span class="p">)</span>
</span><span class='line'>  <span class="o">[</span><span class="n">company_1</span><span class="p">,</span> <span class="n">company_2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">company</span><span class="o">|</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">companies</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="kp">include</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">companies</span> <span class="o">&lt;&lt;</span> <span class="n">company</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">companies</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Run your tests and it&#8217;ll fail for several reasons. Work through them one-by-one until it&#8217;s passing. Here&#8217;s how I did it:</p>

<ul>
<li>Create a <code>Fabricator</code> for <code>Company</code> similar to the one for <code>Person</code></li>
<li>Add the <code>belongs_to :user</code> association for <code>Company</code></li>
<li>Add the <code>has_many :companies</code> association for <code>User</code></li>
<li>Create a migration to add <code>user_id</code> to the companies table</li>
</ul>

<p>With that, the tests should pass.</p>

<h3>Refactoring the Interface</h3>

<p>The most important part of adding the <code>User</code> and associations is that when a <code>User</code> is logged in they should only see their own contacts. How can we ensure that?</p>

<h4>Writing an Integration Test</h4>

<p>Let&#8217;s write integration tests to challenge this behavior. Create a new file <code>spec/features/people_view_spec.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rails&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;the people view&#39;</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="ss">:feature</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;when logged in&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;displays people associated with the user&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">person_1</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>      <span class="n">person_1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>      <span class="n">person_1</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>      <span class="n">visit</span><span class="p">(</span><span class="n">people_path</span><span class="p">)</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_text</span><span class="p">(</span><span class="n">person_1</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
Run that and it should pass.

#### The Negative Case

Now let&#8217;s make sure they don&#8217;t see other user&#8217;s contacts. Here&#8217;s an example.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;does not display people associated with another user&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user_2</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</span><span class='line'>  <span class="n">person_2</span> <span class="o">=</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">person_2</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user_2</span>
</span><span class='line'>  <span class="n">person_2</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>  <span class="n">visit</span><span class="p">(</span><span class="n">people_path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_text</span><span class="p">(</span><span class="n">person_2</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>We create a second user, attach them to a second person, then visit the listing. Run your tests and this test will fail because the index is still showing <em>all</em> the people in the database.</p>

<h4>Scoping to the Current User</h4>

<p>Open up the <code>PeopleController</code> and look at the <code>index</code> action. It&#8217;s querying for <code>Person.all</code>, but we want it to only display the people for <code>current_user</code>. Change the action so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="vi">@people</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">people</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then run your tests and you&#8217;ll find your test is crashing because <code>current_user</code> is <code>nil</code>. Our tests aren&#8217;t logging in, so there is no <code>current_user</code>.</p>

<h4>Faking a Login</h4>

<p>We need to have our tests &quot;login&quot; to the system. We don&#8217;t want to actually connect to the login provider, we want to mock a request/response cycle.</p>

<p>Here&#8217;s one way to do it. Create a folder <code>spec/support</code> if you don&#8217;t have one already. In there create file named <code>omniauth.rb</code>. In this file we can define methods that will be available to all specs in the test suite. Here&#8217;s how we can fake the login:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">login_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>  <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mock_auth</span><span class="o">[</span><span class="ss">:twitter</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;provider&quot;</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;uid&quot;</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;info&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">visit</span><span class="p">(</span><span class="n">login_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now we can call the <code>login_as</code> method from any spec, passing in the desired <code>User</code> object, then the system will believe they have logged in.</p>

<p>Update the tests so that the user logs in right before visiting the people path.</p>

<p>This should get the people view feature specs passing.</p>

<p>Run all your tests. We have two failures, both are because we changed the behavior of the index action in the <code>PeopleController</code>.</p>

<p>Let&#8217;s start with the people controller specs. The test is failing here because we assert that the people are assigned to the page, but this only happens if you&#8217;re logged in now.</p>

<p>Let&#8217;s update the test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;GET index&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;assigns the current user&#39;s people&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'>    <span class="n">assigns</span><span class="p">(</span><span class="ss">:people</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">eq</span><span class="p">(</span><span class="o">[</span><span class="n">person</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The tests fail:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Can&#39;t mass-assign protected attributes: user_id
</span></code></pre></td></tr></table></div></figure>

<p>Add the user to the list of attributes that are <code>attr_accessible</code> inside the <code>Person</code> model.</p>

<p><b>Note to self: exposing the user_id might not be the best idea ever. Security hole. Should we rework this section?</b></p>

<p>The people controller specs should now be passing.</p>

<p>Run all your specs. The last failure is the <code>spec/request/people_spec.rb</code>. Since this spec is duplicating tests that we already have in the features, go ahead and delete the test.</p>

<h4>Refactoring <code>person_view_spec</code></h4>

<p>Now that we want to scope down to just people attached to the current user we&#8217;ll need to make some changes to <code>person_view_spec.rb</code>.</p>

<p>First, let&#8217;s use the person fabricator in the <code>let</code> block for <code>:person</code>.</p>

<p>The tests should still pass.</p>

<p>Add a <code>user</code> that the specs can use to log in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">person</span><span class="o">.</span><span class="n">user</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now inside of the <code>describe 'phone numbers'</code> example group, log the user in before visiting the person path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;555-1234&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">phone_numbers</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="s2">&quot;555-5678&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">login_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>  <span class="n">visit</span> <span class="n">person_path</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Do the same thing with the <code>describe 'email addresses'</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">email_addresses</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="s1">&#39;one@example.com&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">person</span><span class="o">.</span><span class="n">email_addresses</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="s1">&#39;two@example.com&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">login_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>  <span class="n">visit</span> <span class="n">person_path</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Before we actually make the change to scope the data down to the current user, let&#8217;s also update the controller specs:</p>

<p>Add the following right inside the first <code>describe</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Update the <code>valid_attributes</code> and <code>valid_session</code> methods to include the <code>user_id</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">valid_attributes</span>
</span><span class='line'>  <span class="p">{</span><span class="s2">&quot;first_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">valid_session</span>
</span><span class='line'>  <span class="p">{</span><span class="n">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>The tests still pass, but we haven&#8217;t actually scoped the page down to show only the current user&#8217;s data.</p>

<p>In the <code>PeopleController</code> change the <code>lookup_user</code> method to only search in the current user&#8217;s people:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">lookup_person</span>
</span><span class='line'>  <span class="vi">@person</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">people</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<h3>And Now, Companies</h3>

<p>You&#8217;ve done good work on people, but now we need to scope companies down to just the logged in user and refactor the tests as necessary.</p>

<p>Follow the same processes and go to it!</p>

<h3>Breathe, Ship</h3>

<p>That was a tough iteration but thinking about the tests helped up find the trouble spots. If your tests are <em>green</em>, check in your code, <code>checkout</code> the master branch, <code>merge</code> your feature branch, and ship it to Heroku!</p>

    
    
      <footer>
        
        
          <div class="sharing">
  
  
</div>

        
      </footer>
    
  </article>


</div>


  <span class="toggle-sidebar"></span>

<aside class="sidebar">
  <div> </div>
</aside>

<script src="/javascripts/sidebar.js" type="text/javascript"> </script>


    </div>

    <div class="footer">
  <p>
    All materials licensed <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0</a>&nbsp;
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" />
  </p>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42709122-1', 'jumpstartlab.com');
ga('send', 'pageview');
</script>
  </div>

  


  <div class="slide-out-div">
  <a class="handle" href="#">Feedback</a>
  <h3>Have Feedback?</h3>
  <p>Did you find an error? Something confusing? We'd love your help:</p>
  <ul>
    <li><a href="#" id="edit_source">Edit the source code of this page directly on GitHub</a></li>
    <li><a href="https://github.com/JumpstartLab/curriculum/issues">Create a new issue on the project's GitHub page</a></li>
  </ul>
  <p>Thanks!</p>
</div>

<script>
  $(function(){
    var pathname = window.location.pathname.replace( ".html", ".markdown" );
    var github_url = "https://github.com/JumpstartLab/curriculum/blob/master/source" + pathname;
    $("a#edit_source").attr('href', github_url);
  });
</script>

</body>
</html>
